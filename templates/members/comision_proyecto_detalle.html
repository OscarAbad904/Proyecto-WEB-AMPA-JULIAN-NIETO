{% extends "public/layout.html" %}

{% block title %}{{ project.title }} | {{ commission.name }} | Proyectos{% endblock %}

{% block head %}
  {% if return_to %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}" />
  {% endif %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/drive_files.css', v='20260106') }}" />
  <script src="{{ url_for('static', filename='js/drive_files.js', v='20260106') }}" defer></script>
  <style>
    /* {% if return_to %} */
    .project-detail { padding-bottom: 4rem; }
    .admin-kicker-row {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 0.35rem;
      flex-wrap: wrap;
    }
    .admin-kicker-row .nav-auth-btn { min-width: 0; }
    .detail-top { display:flex; align-items:flex-start; justify-content:space-between; gap: 1rem; flex-wrap:wrap; margin-bottom: 1.25rem; }
    .detail-headline { display:flex; flex-direction:column; gap: 0.25rem; }
    .detail-meta { display:flex; flex-wrap:wrap; gap: 0.6rem; align-items:center; color:#64748b; font-weight:700; }
    .detail-actions { display:flex; flex-wrap:wrap; gap: 0.6rem; align-items:center; }
    .detail-actions .btn-link { background:#f8fafc; border:1px solid #e2e8f0; border-radius: 999px; padding: 0.6rem 0.95rem; text-decoration:none; font-weight:800; color:#0f172a; }
    .detail-actions .btn-link:hover { background:#eef2ff; }
    .btn-link--accent {
      background:#f97316;
      border:1px solid #e2e8f0;
      border-radius: 999px;
      padding: 0.6rem 0.95rem;
      text-decoration:none;
      font-weight:800;
      color:#f8fafc;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }
    .btn-link--accent:hover { background:#fb923c; }

    .detail-grid { display:grid; grid-template-columns: minmax(0, 1.15fr) minmax(0, 1fr); gap: 1rem; align-items:start; }
    .detail-grid .admin-card { padding: 1.25rem; }
    .detail-column--shell {
      background: #ffffff;
      border-radius: 1.35rem;
      padding: 0.7rem;
      border: 1px solid #e2e8f0;
      box-shadow: 0 14px 28px rgba(15, 23, 42, 0.08);
    }
    .detail-column--shell .admin-card {
      background: linear-gradient(135deg, #f8fafc 0%, #e8eef3 55%, #d7dee5 100%);
      border: 1px solid #cbd5e1;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }

    .metrics { display:flex; flex-wrap:wrap; gap: 0.75rem; margin-top: 0.9rem; }
    .metric { flex: 1 1 180px; background:#f8fafc; border:1px solid #e2e8f0; border-radius: 0.85rem; padding: 0.75rem 0.9rem; }
    .metric-label { margin:0; font-size: 0.78rem; text-transform: uppercase; letter-spacing: 0.08em; color:#64748b; font-weight: 800; }
    .metric-value { margin:0.25rem 0 0; font-size: 1.05rem; color:#0f172a; font-weight: 900; }

    .stack { display:flex; flex-direction:column; gap: 0.75rem; }
    .item { border: 1px solid #e2e8f0; border-radius: 1rem; padding: 0.9rem 1rem; background: #ffffff; box-shadow: 0 10px 26px rgba(15, 23, 42, 0.14); }
    .stack a.item,
    .stack .discussion-item { box-shadow: 0 14px 30px rgba(15, 23, 42, 0.18); transition: transform .12s ease, box-shadow .2s ease, border-color .2s ease; }
    .stack a.item:hover,
    .stack .discussion-item:hover { transform: translateY(-2px); border-color: rgba(139,92,246,0.35); box-shadow: 0 22px 50px rgba(15,23,42,0.22); }
    .item-top { display:flex; align-items:center; justify-content:space-between; gap: 0.75rem; flex-wrap:wrap; }
    .item h4 { margin: 0.35rem 0 0; color:#0f172a; }
    .item p { margin: 0.35rem 0 0; color:#475569; }
    .item .meta { display:flex; flex-wrap:wrap; gap: 0.5rem; align-items:center; color:#64748b; font-weight:700; }
    .meeting-row { display:flex; align-items:center; gap: 0.5rem; flex-wrap:wrap; }
    .meeting-row h4 { margin: 0; }
    .meeting-dates { display:flex; flex-wrap:wrap; gap: 0.25rem; justify-content:flex-start; }
    .date-chip {
      display:inline-flex;
      align-items:center;
      padding: 0.14rem 0.45rem;
      border-radius: 9999px;
      font-size: 0.9rem;
      font-weight: 800;
      letter-spacing: 0.01em;
    }
    .date-chip--upcoming { background:#2563eb; color:#ffffff; padding:5px 10px;}
    .date-chip--past { background:#f59e0b; color:#ffffff; padding:5px 10px;}
    .section-title-row { display:flex; align-items:center; justify-content:space-between; gap:0.75rem; flex-wrap:wrap; margin-bottom:0.75rem }
    .project-sections { display:flex; flex-direction:column; gap: 1rem; grid-column: 1 / 2; min-width: 0; }

    .meeting-actions { display:flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.65rem; }
    .meeting-actions .btn-link { padding: 0.35rem 0.85rem; font-size: 0.85rem; }
    .meeting-actions .btn-link.danger { background: #ef4444; border-color: #ef4444; color: #ffffff; }

    /* Meeting item styles */
    .meetings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 0.6rem;
      align-items: start;
    }
    .meetings-grid .meeting-item-container { width: 100%; }
    .meetings-grid .meeting-date-chip { width: 100%; }
    .meetings-grid .meeting-date-chip--empty { grid-column: 1 / -1; }
    .meeting-item-container {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .meeting-date-chip {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-width: 90px;
      padding: 0.5rem 0.6rem;
      border-radius: 0.75rem;
      background: #2563eb;
      color: #ffffff;
      font-weight: 800;
      text-align: center;
      flex-shrink: 0;
    }
    .meeting-date-chip--past {
      background: #f59e0b;
    }
    .meeting-date-chip__date {
      font-size: 0.9rem;
      line-height: 1.2;
    }
    .meeting-date-chip__time {
      font-size: 0.85rem;
      opacity: 0.9;
      margin-top: 0.15rem;
    }
    .meeting-date-chip__actions {
      display: flex;
      gap: 0.3rem;
      margin-top: 0.4rem;
      padding-top: 0.4rem;
      border-top: 1px solid rgba(255, 255, 255, 0.3);
    }
    .meeting-date-chip__actions .icon-square {
      width: 28px;
      height: 28px;
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: #ffffff;
    }
    .meeting-date-chip__actions .icon-square:hover {
      background: rgba(255, 255, 255, 0.35);
    }
    .meeting-date-chip__actions .icon-square svg {
      width: 14px;
      height: 14px;
    }
    .meeting-date-chip__actions .icon-square--danger:hover {
      background: rgba(239, 68, 68, 0.8);
      border-color: rgba(239, 68, 68, 0.9);
    }
    .meeting-date-chip--empty {
      font-size: 0.85rem;
      padding: 0.6rem 1rem;
    }

    /* Meeting detail modal */
    .meeting-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 1200;
    }
    .meeting-modal.open { opacity: 1; pointer-events: auto; }
    .meeting-modal__dialog {
      background: #ffffff;
      border-radius: 1rem;
      width: min(92vw, 520px);
      max-height: 80vh;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.25);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .meeting-modal__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid #e2e8f0;
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    }
    .meeting-modal__header h3 { margin: 0; color:#0f172a; }
    .meeting-modal__close {
      background: none;
      border: none;
      font-size: 1.5rem;
      line-height: 1;
      cursor: pointer;
      color: #64748b;
    }
    .meeting-modal__close:hover { color: #0f172a; }
    .meeting-modal__body {
      padding: 1rem 1.25rem 1.25rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .meeting-modal__field {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .meeting-modal__label {
      font-weight: 700;
      color: #64748b;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .meeting-modal__value {
      color: #0f172a;
      line-height: 1.5;
    }
    .meeting-modal__docs {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .meeting-modal__doc-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: #3b82f6;
      text-decoration: none;
      font-weight: 600;
    }
    .meeting-modal__doc-link:hover {
      text-decoration: underline;
    }

    @media (max-width: 720px) {
      .detail-grid { grid-template-columns: 1fr; }
      .project-sections,
      .project-discussions { grid-column: 1 / -1; }
    }
    /* {% else %} */
    a.compact {
      cursor: pointer;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), border-color var(--transition-fast);
    }
    a.compact:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg, 0 18px 38px rgba(15, 23, 42, 0.16));
    }
    a.compact:focus-visible {
      outline: 2px solid var(--color-primary, #1f3ba2);
      outline-offset: 2px;
    }
    .btn-link--accent {
      background:#f97316;
      border:1px solid #e2e8f0;
      border-radius: 999px;
      padding: 0.6rem 0.95rem;
      text-decoration:none;
      font-weight:800;
      color:#f8fafc;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }
    .btn-link--accent:hover { background:#fb923c; }
    .project-sections { display:flex; flex-direction:column; }
    .project-section + .project-section { margin-top: 1.25rem; padding-top: 1.25rem; border-top: 1px solid var(--color-neutral-200, #e5e7eb); }
    .meeting-actions { display:flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.65rem; }
    .meeting-actions .btn-link { padding: 0.35rem 0.85rem; font-size: 0.85rem; }
    .meeting-actions .btn-link.danger { background: #ef4444; border-color: #ef4444; color: #ffffff; }
    /* {% endif %} */
  </style>
{% endblock %}

{% block content %}
{% if return_to %}
  <section class="admin-wrapper project-detail">
    <div class="admin-header">
      <div class="admin-kicker-row">
        <p class="admin-kicker">Comisiones - {{ commission.name }} - {{ project.title }}</p>
        <a class="nav-auth-btn nav-auth-btn--logout" href="{{ back_url }}">{{ back_label }}</a>
      </div>
      <div class="detail-top">
        <div class="detail-headline">
          <h1 class="admin-title" style="margin-top:0.25rem;">{{ project.title }}</h1>
          <div class="detail-meta">
            <span>Comisi贸n: {{ commission.name }}</span>
            <span class="chip">{{ project.status.replace('_', ' ') }}</span>
            <span>Responsable: {% if project.responsible %}{{ project.responsible.display_name }}{% else %}Sin asignar{% endif %}</span>
            <span>Inicio: {% if project.start_date %}{{ project.start_date.strftime('%d/%m/%Y') }}{% else %}Sin fecha{% endif %}</span>
            <span>Fin: {% if project.end_date %}{{ project.end_date.strftime('%d/%m/%Y') }}{% else %}Sin fecha{% endif %}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="detail-grid">
      <div class="project-sections detail-column--shell">
        <div class="admin-card project-section">
        <div class="section-title-row">
          <h3 style="margin:0;">Descripci贸n</h3>
        </div>
        <div class="rich-text" style="margin-top:0.75rem;">
          {% if project.description_html %}
            {{ project.description_html | safe }}
          {% else %}
            <p class="muted">Sin descripci贸n.</p>
          {% endif %}
        </div>
        </div>
        <div class="admin-card project-section">
          <div class="section-title-row">
            <h3 style="margin:0;">Reuniones de Proyecto</h3>
            {% if can_manage_meetings %}
              <a class="btn-link btn-link--accent" href="{{ url_for('members.project_meeting_form', slug=commission.slug, project_id=project.id, return_to=return_to) }}" style="background:#f97316; border:none; border-radius: 999px; padding: 0.6rem 0.95rem; text-decoration:none; font-weight:800; color:#f8fafc;">Nueva reuni贸n</a>
            {% endif %}
          </div>
          <div class="stack">
          <div class="meeting-row">
            <h4>Pr贸ximas</h4>
          </div>
          <div class="meetings-grid">
            {% if project_upcoming_meetings %}
            {% for meeting in project_upcoming_meetings %}
            <div class="meeting-item-container">
              <div class="meeting-date-chip">
                <span class="meeting-date-chip__date">{{ meeting.start_at.strftime("%d/%m/%Y") }}</span>
                <span class="meeting-date-chip__time">{{ meeting.start_at.strftime("%H:%M") }}</span>
                <div class="meeting-date-chip__actions">
                  <button type="button" class="icon-square" aria-label="Ver detalles" onclick="openProjectMeetingModal({{ meeting.id }})">
                    <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" focusable="false">
                      <path d="M2.5 12s3.8-6.5 9.5-6.5S21.5 12 21.5 12s-3.8 6.5-9.5 6.5S2.5 12 2.5 12Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                      <circle cx="12" cy="12" r="3.2" stroke="currentColor" stroke-width="1.8" />
                    </svg>
                  </button>
                  {% if can_manage_meetings %}
                  <a class="icon-square" href="{{ url_for('members.project_meeting_form', slug=commission.slug, project_id=project.id, meeting_id=meeting.id, return_to=return_to) }}" aria-label="Editar reuni贸n">
                    <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" focusable="false">
                      <path d="M12 20h9" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                      <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                  </a>
                  <button type="button" class="icon-square icon-square--danger" aria-label="Eliminar reuni贸n" onclick="confirmDeleteProjectMeeting({{ meeting.id }}, '{{ meeting.title | e }}')">
                    <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" focusable="false">
                      <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h14Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                      <path d="M10 11v6M14 11v6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                  </button>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="meeting-date-chip meeting-date-chip--empty"> No hay reuniones pr贸ximas.</div>
            {% endif %}
          </div>

          <div class="meeting-row" style="margin-top: 0.6rem;">
            <h4>Historial</h4>
          </div>
          <div class="meetings-grid">
            {% if project_past_meetings %}
            {% for meeting in project_past_meetings %}
            <div class="meeting-item-container">
              <div class="meeting-date-chip meeting-date-chip--past">
                <span class="meeting-date-chip__date">{{ meeting.start_at.strftime("%d/%m/%Y") }}</span>
                <span class="meeting-date-chip__time">{{ meeting.start_at.strftime("%H:%M") }}</span>
                <div class="meeting-date-chip__actions">
                  <button type="button" class="icon-square" aria-label="Ver detalles" onclick="openProjectMeetingModal({{ meeting.id }})">
                    <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" focusable="false">
                      <path d="M2.5 12s3.8-6.5 9.5-6.5S21.5 12 21.5 12s-3.8 6.5-9.5 6.5S2.5 12 2.5 12Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                      <circle cx="12" cy="12" r="3.2" stroke="currentColor" stroke-width="1.8" />
                    </svg>
                  </button>
                  {% if can_manage_meetings %}
                  <a class="icon-square" href="{{ url_for('members.project_meeting_form', slug=commission.slug, project_id=project.id, meeting_id=meeting.id, return_to=return_to) }}" aria-label="Editar reuni贸n">
                    <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" focusable="false">
                      <path d="M12 20h9" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                      <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                  </a>
                  <button type="button" class="icon-square icon-square--danger" aria-label="Eliminar reuni贸n" onclick="confirmDeleteProjectMeeting({{ meeting.id }}, '{{ meeting.title | e }}')">
                    <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" focusable="false">
                      <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h14Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                      <path d="M10 11v6M14 11v6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                  </button>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="meeting-date-chip meeting-date-chip--past meeting-date-chip--empty"> No hay reuniones pasadas.</div>
            {% endif %}
          </div>
        </div>
      </div>

      {% set drive_label = "proyecto" %}
      {% set drive_upload_title = "Sube archivos al proyecto" %}
      {% set drive_list_title = "Archivos del proyecto" %}
      {% set drive_list_button = "Ver archivos del proyecto" %}
      {% set drive_list_url = url_for('api.project_drive_files_list', project_id=project.id) %}
      {% set drive_upload_url = url_for('api.project_drive_files_upload', project_id=project.id) %}
      {% set drive_download_url = url_for('api.project_drive_files_download', project_id=project.id, file_id='__FILE_ID__') %}
      {% set drive_delete_url = url_for('api.project_drive_files_delete', project_id=project.id, file_id='__FILE_ID__') %}
      {% set drive_history_url = url_for('api.project_drive_files_history', project_id=project.id) %}
      {% set drive_restore_url = url_for('api.project_drive_files_restore', project_id=project.id, file_id='__FILE_ID__') %}
      {% set drive_description_url = url_for('api.project_drive_files_update_description', project_id=project.id, file_id='__FILE_ID__') %}
      {% set drive_can_delete = can_manage_drive_files %}
      {% set drive_can_history = can_view_drive_history %}
      {% include 'shared/drive_files_widget.html' %}

      </div>

      <div class="detail-column--shell">
      <div class="admin-card project-section">
        <div class="section-title-row">
          <h3 style="margin:0;">Discusiones activas del proyecto</h3>
          {% if can_create_discussions %}
            <a class="btn-link btn-link--accent" href="{{ url_for('members.project_discussion_new', slug=commission.slug, project_id=project.id, return_to=return_to) }}" style="background:#f97316; border:none; border-radius: 999px; padding: 0.6rem 0.95rem; text-decoration:none; font-weight:800; color:#f8fafc;">Abrir discusi贸n</a>
          {% endif %}
        </div>
        <div class="stack">
          {% for discussion in project_discussions %}
            <article class="item discussion-item" role="link" tabindex="0" data-href="{{ url_for('members.detalle_sugerencia', suggestion_id=discussion.id, return_to=project_self_url) }}">
              <div class="item-top">
                <div class="meta">
                  <span class="chip">{{ discussion.status }}</span>
                  <span>{{ project_discussion_vote_counts.get(discussion.id, 0) }} votos</span>
                  {% if discussion.updated_at %}
                    <span>Actualizada: {{ discussion.updated_at.strftime('%d/%m/%Y %H:%M') }}</span>
                  {% endif %}
                </div>
              </div>
              <h4>{{ discussion.title }}</h4>
            </article>
          {% else %}
            <p class="muted" style="margin:0;">No hay discusiones todav铆a.</p>
          {% endfor %}
        </div>

      </div>

      </div>
    </div>

  </section>
{% else %}
  <section class="page-section">
    <div class="container">
      <header class="section-header">
        <div>
          <p class="eyebrow">Comisi贸n 路 {{ commission.name }}</p>
          <h1 class="section-title">{{ project.title }}</h1>
          <p class="section-subtitle">Proyecto 路 {{ project.status }}</p>
        </div>
        <div class="header-actions">
          <a class="btn-link" href="{{ back_url }}">{{ back_label }}</a>
        </div>
      </header>

      <div class="card project-sections">
        <div class="project-section">
        <h3>Descripci贸n</h3>
        <div class="rich-text">
          {% if project.description_html %}
            {{ project.description_html | safe }}
          {% else %}
            <p>Sin descripci贸n.</p>
          {% endif %}
        </div>
        <p class="small" style="margin-top: 0.75rem;">
          {% if project.start_date %}Inicio: {{ project.start_date.strftime('%d/%m/%Y') }}{% endif %}
          {% if project.end_date %} 路 Fin: {{ project.end_date.strftime('%d/%m/%Y') }}{% endif %}
        </p>
        {% if project.responsible %}
          <p class="small" style="margin-top: 0.35rem;">Responsable: <strong>{{ project.responsible.display_name }}</strong></p>
        {% endif %}
        </div>
        <div class="project-section">
          <div class="card-header">
            <h3>Reuniones de Proyecto</h3>
            {% if can_manage_meetings %}
              <a class="btn-link btn-link--accent" href="{{ url_for('members.project_meeting_form', slug=commission.slug, project_id=project.id, return_to=return_to) }}">Nueva reuni贸n</a>
            {% endif %}
          </div>

          <div class="stack">
            <div class="meeting-row">
              <h4>Pr贸ximas</h4>
            </div>
              <div class="meetings-grid">
                {% if project_upcoming_meetings %}
                  {% for meeting in project_upcoming_meetings %}
                  <div class="meeting-item-container">
                    <div class="meeting-date-chip">
                      <span class="meeting-date-chip__date">{{ meeting.start_at.strftime("%d/%m/%Y") }}</span>
                      <span class="meeting-date-chip__time">{{ meeting.start_at.strftime("%H:%M") }}</span>
                      <div class="meeting-date-chip__actions">
                        <button type="button" class="icon-square" aria-label="Ver detalles" onclick="openProjectMeetingModal({{ meeting.id }})">
                          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" focusable="false">
                            <path d="M2.5 12s3.8-6.5 9.5-6.5S21.5 12 21.5 12s-3.8 6.5-9.5 6.5S2.5 12 2.5 12Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                            <circle cx="12" cy="12" r="3.2" stroke="currentColor" stroke-width="1.8" />
                          </svg>
                        </button>
                        {% if can_manage_meetings %}
                        <a class="icon-square" href="{{ url_for('members.project_meeting_form', slug=commission.slug, project_id=project.id, meeting_id=meeting.id, return_to=return_to) }}" aria-label="Editar reuni贸n">
                          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" focusable="false">
                            <path d="M12 20h9" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                            <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                          </svg>
                        </a>
                        <button type="button" class="icon-square icon-square--danger" aria-label="Eliminar reuni贸n" onclick="confirmDeleteProjectMeeting({{ meeting.id }}, '{{ meeting.title | e }}')">
                          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" focusable="false">
                            <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h14Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M10 11v6M14 11v6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                          </svg>
                        </button>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  {% endfor %}
                {% else %}
                  <div class="meeting-date-chip meeting-date-chip--empty"> No hay reuniones pr贸ximas.</div>
                {% endif %}
              </div>

            <div class="meeting-row" style="margin-top: 0.6rem;">
              <h4>Historial</h4>
            </div>
            <div class="meetings-grid">
              {% if project_past_meetings %}
                {% for meeting in project_past_meetings %}
                <div class="meeting-item-container">
                  <div class="meeting-date-chip meeting-date-chip--past">
                    <span class="meeting-date-chip__date">{{ meeting.start_at.strftime("%d/%m/%Y") }}</span>
                    <span class="meeting-date-chip__time">{{ meeting.start_at.strftime("%H:%M") }}</span>
                    <div class="meeting-date-chip__actions">
                      <button type="button" class="icon-square" aria-label="Ver detalles" onclick="openProjectMeetingModal({{ meeting.id }})">
                        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" focusable="false">
                          <path d="M2.5 12s3.8-6.5 9.5-6.5S21.5 12 21.5 12s-3.8 6.5-9.5 6.5S2.5 12 2.5 12Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                          <circle cx="12" cy="12" r="3.2" stroke="currentColor" stroke-width="1.8" />
                        </svg>
                      </button>
                      {% if can_manage_meetings %}
                      <a class="icon-square" href="{{ url_for('members.project_meeting_form', slug=commission.slug, project_id=project.id, meeting_id=meeting.id, return_to=return_to) }}" aria-label="Editar reuni贸n">
                        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" focusable="false">
                          <path d="M12 20h9" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                          <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                      </a>
                      <button type="button" class="icon-square icon-square--danger" aria-label="Eliminar reuni贸n" onclick="confirmDeleteProjectMeeting({{ meeting.id }}, '{{ meeting.title | e }}')">
                        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" focusable="false">
                          <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h14Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                          <path d="M10 11v6M14 11v6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                      </button>
                      {% endif %}
                    </div>
                  </div>
                </div>
                {% endfor %}
              {% else %}
                <div class="meeting-date-chip meeting-date-chip--past meeting-date-chip--empty"> No hay reuniones pasadas.</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      </div>

      {% set drive_label = "proyecto" %}
      {% set drive_upload_title = "Sube archivos al proyecto" %}
      {% set drive_list_title = "Archivos del proyecto" %}
      {% set drive_list_button = "Ver archivos del proyecto" %}
      {% set drive_list_url = url_for('api.project_drive_files_list', project_id=project.id) %}
      {% set drive_upload_url = url_for('api.project_drive_files_upload', project_id=project.id) %}
      {% set drive_download_url = url_for('api.project_drive_files_download', project_id=project.id, file_id='__FILE_ID__') %}
      {% set drive_delete_url = url_for('api.project_drive_files_delete', project_id=project.id, file_id='__FILE_ID__') %}
      {% set drive_history_url = url_for('api.project_drive_files_history', project_id=project.id) %}
      {% set drive_restore_url = url_for('api.project_drive_files_restore', project_id=project.id, file_id='__FILE_ID__') %}
      {% set drive_description_url = url_for('api.project_drive_files_update_description', project_id=project.id, file_id='__FILE_ID__') %}
      {% set drive_can_delete = can_manage_drive_files %}
      {% set drive_can_history = can_view_drive_history %}
      {% include 'shared/drive_files_widget.html' %}

      <div class="card">
        <div class="card-header">
          <h3>Discusiones del proyecto</h3>
          {% if can_create_discussions %}
            <a class="btn-link" href="{{ url_for('members.project_discussion_new', slug=commission.slug, project_id=project.id, return_to=return_to) }}">Nueva discusi贸n</a>
          {% endif %}
        </div>

        <div class="stack">
          {% for discussion in project_discussions %}
            <a class="compact" href="{{ url_for('members.detalle_sugerencia', suggestion_id=discussion.id, return_to=project_self_url) }}" style="display:block; text-decoration:none; color:inherit;">
              <div class="meta">
                <span class="badge">{{ discussion.status }}</span>
                <span>{{ project_discussion_vote_counts.get(discussion.id, 0) }} votos</span>
                {% if discussion.updated_at %}
                  <span>{{ discussion.updated_at.strftime('%d/%m/%Y %H:%M') }}</span>
                {% endif %}
              </div>
              <h4>{{ discussion.title }}</h4>
            </a>
          {% else %}
            <p>No hay discusiones todav铆a.</p>
          {% endfor %}
        </div>
      </div>

    </div>
  </section>
{% endif %}

<!-- Modal de detalles de reuni贸n de proyecto -->
<div class="meeting-modal" id="project-meeting-detail-modal" aria-hidden="true">
  <div class="meeting-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="project-meeting-modal-title">
    <div class="meeting-modal__header">
      <h3 id="project-meeting-modal-title">Detalles de la reuni贸n</h3>
      <button class="meeting-modal__close" type="button" data-close-meeting-modal aria-label="Cerrar">&times;</button>
    </div>
    <div class="meeting-modal__body" id="project-meeting-modal-body">
      <!-- El contenido se carga din谩micamente -->
    </div>
  </div>
</div>

<!-- Formulario oculto para eliminar reuniones de proyecto -->
<form id="delete-project-meeting-form" method="post" action="" style="display:none;">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
</form>

<script>
  // Datos de reuniones de proyecto para el modal
  window.projectMeetingsData = {
    {% for meeting in project_upcoming_meetings %}
    {{ meeting.id }}: {
      title: "{{ meeting.title | e }}",
      date: "{{ meeting.start_at.strftime('%d/%m/%Y %H:%M') }}",
      location: "{{ meeting.location | e if meeting.location else '' }}",
      description: "{{ meeting.description_html | striptags | e if meeting.description_html else '' }}",
      documents: [
        {% if meeting.minutes_document %}
        { name: "Acta", url: "{{ meeting.minutes_document.file_path }}" }
        {% endif %}
      ]
    },
    {% endfor %}
    {% for meeting in project_past_meetings %}
    {{ meeting.id }}: {
      title: "{{ meeting.title | e }}",
      date: "{{ meeting.start_at.strftime('%d/%m/%Y %H:%M') }}",
      location: "{{ meeting.location | e if meeting.location else '' }}",
      description: "{{ meeting.description_html | striptags | e if meeting.description_html else '' }}",
      documents: [
        {% if meeting.minutes_document %}
        { name: "Acta", url: "{{ meeting.minutes_document.file_path }}" }
        {% endif %}
      ]
    },
    {% endfor %}
  };

  // Funcionalidad del modal de detalles de reuni贸n de proyecto
  (function () {
    const meetingModal = document.getElementById('project-meeting-detail-modal');
    if (!meetingModal) return;
    
    const closeBtn = meetingModal.querySelector('[data-close-meeting-modal]');
    
    const toggleMeetingModal = (show) => {
      meetingModal.classList.toggle('open', show);
      meetingModal.setAttribute('aria-hidden', show ? 'false' : 'true');
    };

    if (closeBtn) {
      closeBtn.addEventListener('click', () => toggleMeetingModal(false));
    }
    meetingModal.addEventListener('click', (event) => {
      if (event.target === meetingModal) toggleMeetingModal(false);
    });
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && meetingModal.classList.contains('open')) toggleMeetingModal(false);
    });

    // Exponer funci贸n global para abrir el modal
    window.openProjectMeetingModal = function(meetingId) {
      const meetingsData = window.projectMeetingsData || {};
      const meeting = meetingsData[meetingId];
      if (!meeting) return;

      const body = document.getElementById('project-meeting-modal-body');
      let html = '';
      
      html += `<div class="meeting-modal__field">
        <span class="meeting-modal__label">T铆tulo</span>
        <span class="meeting-modal__value">${meeting.title}</span>
      </div>`;
      
      html += `<div class="meeting-modal__field">
        <span class="meeting-modal__label">Fecha y hora</span>
        <span class="meeting-modal__value"> ${meeting.date}</span>
      </div>`;
      
      if (meeting.location) {
        html += `<div class="meeting-modal__field">
          <span class="meeting-modal__label">Ubicaci贸n</span>
          <span class="meeting-modal__value"> ${meeting.location}</span>
        </div>`;
      }
      
      if (meeting.description) {
        html += `<div class="meeting-modal__field">
          <span class="meeting-modal__label">Descripci贸n</span>
          <span class="meeting-modal__value">${meeting.description}</span>
        </div>`;
      }
      
      if (meeting.documents && meeting.documents.length > 0) {
        html += `<div class="meeting-modal__field">
          <span class="meeting-modal__label">Documentos adjuntos</span>
          <div class="meeting-modal__docs">`;
        meeting.documents.forEach(doc => {
          html += `<a href="${doc.url}" target="_blank" class="meeting-modal__doc-link"> ${doc.name}</a>`;
        });
        html += `</div></div>`;
      }

      body.innerHTML = html;
      toggleMeetingModal(true);
    };

    // Funci贸n global para confirmar eliminaci贸n de reuni贸n de proyecto
    window.confirmDeleteProjectMeeting = function(meetingId, meetingTitle) {
      if (confirm(`锔 驴Est谩s seguro de que quieres eliminar la reuni贸n "${meetingTitle}"? Esta acci贸n no se puede deshacer.`)) {
        const form = document.getElementById('delete-project-meeting-form');
        form.action = "{{ url_for('members.project_meeting_delete', slug=commission.slug, project_id=project.id, meeting_id=0, return_to=return_to) }}".replace('/0/', '/' + meetingId + '/');
        form.submit();
      }
    };
  })();
</script>
{% endblock %}
