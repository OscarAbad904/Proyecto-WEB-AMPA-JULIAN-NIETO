{% extends "public/layout.html" %}

{% block title %}{{ commission.name }} | Comisiones{% endblock %}

{% block head %}
  <style>
    a.compact {
      cursor: pointer;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), border-color var(--transition-fast);
    }
    .compact.is-clickable {
      cursor: pointer;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), border-color var(--transition-fast);
    }
    a.compact:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg, 0 18px 38px rgba(15, 23, 42, 0.16));
    }
    .compact.is-clickable:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg, 0 18px 38px rgba(15, 23, 42, 0.16));
    }
    a.compact:focus-visible {
      outline: 2px solid var(--color-primary, #1f3ba2);
      outline-offset: 2px;
    }
    .compact.is-clickable:focus-visible {
      outline: 2px solid var(--color-primary, #1f3ba2);
      outline-offset: 2px;
    }
  </style>
{% endblock %}

{% block content %}
<section class="page-section">
  <div class="container">
    <header class="section-header">
      <div>
        <p class="eyebrow">Comision</p>
        <h1 class="section-title">{{ commission.name }}</h1>
        {% if membership %}
        <p class="section-subtitle">Tu rol: {{ membership.role }}</p>
        {% endif %}
      </div>
      <div class="header-actions">
        {% if can_edit_commission %}
        <a class="btn-link" href="{{ url_for('admin.commission_edit', commission_id=commission.id) }}">Editar ficha</a>
        {% endif %}
      </div>
    </header>

    <div class="card">
      <h3>Descripcion y objetivos</h3>
      <div class="rich-text">
        {% if commission.description_html %}
          {{ commission.description_html | safe }}
        {% else %}
          <p>Sin descripcion.</p>
        {% endif %}
      </div>
    </div>

    <div class="card-grid">
      <div class="card">
        <div class="card-header">
          <h3>Miembros</h3>
          {% if can_manage_members %}
          <a class="btn-link" href="{{ url_for('members.commission_member_new', slug=commission.slug) }}">A√±adir miembro</a>
          {% endif %}
        </div>
        <ul class="list">
          {% for member in members %}
          <li class="list-item">
            <div>
              <strong>{{ member.user.display_name }}</strong>
              <span class="badge">{{ member.role }}</span>
            </div>
            {% if can_manage_members and member.is_active %}
            <form method="post" action="{{ url_for('members.commission_member_disable', slug=commission.slug, membership_id=member.id) }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="btn-link danger">Desactivar</button>
            </form>
            {% endif %}
          </li>
          {% else %}
          <li>No hay miembros activos.</li>
          {% endfor %}
        </ul>
      </div>

      <div class="card">
        <div class="card-header">
          <h3>Proyectos</h3>
          {% if can_manage_projects %}
          <a class="btn-link" href="{{ url_for('members.commission_project_form', slug=commission.slug) }}">Nuevo proyecto</a>
          {% endif %}
        </div>
        <div class="stack">
          {% for project in projects %}
          <article
            class="compact is-clickable"
            role="link"
            tabindex="0"
            onclick="window.location.href='{{ url_for('members.commission_project_detail', slug=commission.slug, project_id=project.id) }}'"
            onkeydown="if(event.key==='Enter' || event.key===' '){event.preventDefault(); window.location.href='{{ url_for('members.commission_project_detail', slug=commission.slug, project_id=project.id) }}';}"
          >
            <div class="meta">
              <span class="badge">{{ project.status }}</span>
              {% if project.responsible %}
              <span>Responsable: {{ project.responsible.display_name }}</span>
              {% endif %}
            </div>
            <h4>{{ project.title }}</h4>
            {% if project.description_html %}
            <p>{{ project.description_html | striptags }}</p>
            {% endif %}
            <p class="small">
              {% if project.start_date %}Inicio: {{ project.start_date.strftime("%d/%m/%Y") }}{% endif %}
              {% if project.end_date %} ¬∑ Fin: {{ project.end_date.strftime("%d/%m/%Y") }}{% endif %}
            </p>
            {% if can_manage_projects %}
            <a class="btn-link" onclick="event.stopPropagation();" href="{{ url_for('members.commission_project_form', slug=commission.slug, project_id=project.id) }}">Editar</a>
            {% endif %}
          </article>
          {% else %}
          <p>No hay proyectos registrados.</p>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3>Discusiones de la comisi√≥n</h3>
        {% if can_create_discussions %}
          <a class="btn-link" href="{{ url_for('members.commission_discussion_new', slug=commission.slug) }}">Nueva discusi√≥n</a>
        {% endif %}
      </div>

      <div class="stack">
        {% for discussion in commission_discussions %}
          <a class="compact" href="{{ url_for('members.detalle_sugerencia', suggestion_id=discussion.id) }}" style="display:block; text-decoration:none; color:inherit;">
            <div class="meta">
              <span class="badge">{{ discussion.status }}</span>
              <span>{{ discussion.votes_count or 0 }} votos</span>
              {% if discussion.updated_at %}
                <span>{{ discussion.updated_at.strftime("%d/%m/%Y %H:%M") }}</span>
              {% endif %}
            </div>
            <h4>{{ discussion.title }}</h4>
          </a>
        {% else %}
          <p>No hay discusiones todav√≠a.</p>
        {% endfor %}
      </div>
    </div>

    <div class="card">
      <style>
        .meeting-actions {
          display: flex;
          gap: 0.5rem;
          flex-wrap: wrap;
          margin-top: 0.75rem;
          padding-top: 0.75rem;
          border-top: 1px solid #e5e7eb;
        }
        .btn-edit {
          background-color: #3b82f6;
          color: white;
          padding: 0.5rem 1rem;
          border-radius: 4px;
          text-decoration: none;
          font-size: 0.9rem;
          transition: background-color 0.2s;
        }
        .btn-edit:hover {
          background-color: #2563eb;
        }
        .btn-delete {
          background-color: #ef4444;
          color: white;
          padding: 0.5rem 1rem;
          border-radius: 4px;
          border: none;
          font-size: 0.9rem;
          cursor: pointer;
          transition: background-color 0.2s;
        }
        .btn-delete:hover {
          background-color: #dc2626;
        }
      </style>

      <div class="card-header">
        <h3>Reuniones</h3>
        {% if can_manage_meetings %}
        <div class="btn-group" style="display: flex; gap: 0.5rem;">
          <a class="btn-primary" href="{{ url_for('members.commission_meeting_form', slug=commission.slug) }}">‚ûï Nueva reuni√≥n</a>
          {% if upcoming_meetings or past_meetings %}
          <a class="btn-link" href="{{ url_for('members.commission_meetings_list', slug=commission.slug) }}">üìã Ver todas</a>
          {% endif %}
        </div>
        {% endif %}
      </div>
      <div class="stack">
        <h4>Pr√≥ximas</h4>
        {% for meeting in upcoming_meetings %}
        <article class="compact" style="border: 2px solid #ef4444; padding: 1rem; border-radius: 8px;">
          <div class="meta">
            <span class="badge">Pr√≥xima</span>
            <span><strong>üìÖ {{ meeting.start_at.strftime("%d/%m/%Y %H:%M") }}</strong></span>
            {% if meeting.location %}<span>üìç {{ meeting.location }}</span>{% endif %}
          </div>
          <h4>{{ meeting.title }}</h4>
          {% if meeting.description_html %}
          <p style="font-size: 0.9rem; color: #666; margin: 0.5rem 0;">{{ meeting.description_html | striptags | truncate(200) }}</p>
          {% endif %}
          {% if can_manage_meetings %}
          <div class="meeting-actions">
            <a href="{{ url_for('members.commission_meeting_form', slug=commission.slug, meeting_id=meeting.id) }}" class="btn-edit">‚úèÔ∏è Editar reuni√≥n</a>
            <form method="post" action="{{ url_for('members.commission_meeting_delete', slug=commission.slug, meeting_id=meeting.id) }}" style="display:inline;" data-confirm="{{ '‚ö†Ô∏è ¬øEst√°s seguro de que quieres eliminar esta reuni√≥n? Se eliminar√° de Google Calendar tambi√©n.' | e }}" data-confirm-title="Eliminar reuni√≥n" data-confirm-accept="Eliminar" data-confirm-variant="danger">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="btn-delete">üóëÔ∏è Eliminar reuni√≥n</button>
            </form>
          </div>
          {% else %}
          <p style="font-size: 0.85rem; color: #999; margin-top: 0.5rem;">üí° Solo coordinadores pueden editar/eliminar</p>
          {% endif %}
        </article>
        {% else %}
        <p>üì≠ No hay reuniones pr√≥ximas.</p>
        {% endfor %}

        <h4 style="margin-top: 1.5rem;">Historial</h4>
        {% for meeting in past_meetings %}
        <article class="compact" style="opacity: 0.8; border-left: 4px solid #9ca3af; padding: 1rem; border-radius: 4px;">
          <div class="meta">
            <span class="badge muted">Pasada</span>
            <span>üìÖ {{ meeting.start_at.strftime("%d/%m/%Y %H:%M") }}</span>
            {% if meeting.location %}<span>üìç {{ meeting.location }}</span>{% endif %}
          </div>
          <h4>{{ meeting.title }}</h4>
          {% if meeting.minutes_document %}
          <a class="btn-link" href="{{ meeting.minutes_document.file_path }}" target="_blank">üìÑ Ver Acta</a>
          {% endif %}
          {% if can_manage_meetings %}
          <div class="meeting-actions">
            <a href="{{ url_for('members.commission_meeting_form', slug=commission.slug, meeting_id=meeting.id) }}" class="btn-edit">‚úèÔ∏è Editar</a>
            <form method="post" action="{{ url_for('members.commission_meeting_delete', slug=commission.slug, meeting_id=meeting.id) }}" style="display:inline;" data-confirm="{{ '‚ö†Ô∏è ¬øEst√°s seguro? Se eliminar√° de Google Calendar tambi√©n.' | e }}" data-confirm-title="Eliminar reuni√≥n" data-confirm-accept="Eliminar" data-confirm-variant="danger">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="btn-delete">üóëÔ∏è Eliminar</button>
            </form>
          </div>
          {% endif %}
        </article>
        {% else %}
        <p>üì≠ No hay reuniones previas.</p>
        {% endfor %}
      </div>
    </div>
  </div>
</section>
{% endblock %}
