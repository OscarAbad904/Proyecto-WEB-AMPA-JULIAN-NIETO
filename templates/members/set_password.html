{% extends "public/layout.html" %}

{% block title %}Crear contraseña - AMPA Julián Nieto{% endblock %}

{% block content %}
  <section class="private-section">
    <div class="private-container">
      <h1 class="private-title">Crea tu contraseña</h1>
      <p class="private-desc">¡Bienvenido/a! Para activar tu cuenta definitivamente, por favor crea una contraseña de acceso.</p>

      <form method="post" action="{{ url_for('public.create_password', token=token) }}" class="private-form" novalidate>
        {{ form.hidden_tag() }}
        <div class="private-field">
          <label for="password">Nueva contraseña</label>
          {{ form.password(placeholder="Mínimo 8 caracteres", autocomplete="new-password", minlength="8") }}
          {% for error in form.password.errors %}
            <p class="form-error">{{ error }}</p>
          {% endfor %}
        </div>
        <div class="private-field">
          <label for="password_confirm">Repite la contraseña</label>
          {{ form.password_confirm(placeholder="Confirma tu contraseña", autocomplete="new-password") }}
          {% for error in form.password_confirm.errors %}
            <p class="form-error">{{ error }}</p>
          {% endfor %}
        </div>
        <div style="margin-top: 1.5rem;">
          {{ form.submit(class_="btn-primary", value="Activar mi cuenta y entrar") }}
        </div>
      </form>
    </div>
  </section>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const passwordInput = document.getElementById('password');
      const confirmInput = document.getElementById('password_confirm');

      function updatePasswordValidity() {
        if (!passwordInput) return;
        const ok = passwordInput.value.length >= 8;
        passwordInput.classList.toggle('input-valid', ok);
      }

      function updateConfirmValidity() {
        if (!passwordInput || !confirmInput) return;
        const passwordOk = passwordInput.value.length >= 8;
        const matchOk = confirmInput.value.length > 0 && confirmInput.value === passwordInput.value;
        confirmInput.classList.toggle('input-valid', passwordOk && matchOk);
      }

      function recheckSoon() {
        // Password managers/autofill sometimes update after DOMContentLoaded
        setTimeout(function () {
          updatePasswordValidity();
          updateConfirmValidity();
        }, 0);
        setTimeout(function () {
          updatePasswordValidity();
          updateConfirmValidity();
        }, 150);
        setTimeout(function () {
          updatePasswordValidity();
          updateConfirmValidity();
        }, 600);
      }

      if (passwordInput) {
        const onPasswordChange = function () {
          updatePasswordValidity();
          updateConfirmValidity();
        };
        passwordInput.addEventListener('input', onPasswordChange);
        passwordInput.addEventListener('keyup', onPasswordChange);
        passwordInput.addEventListener('change', onPasswordChange);
        passwordInput.addEventListener('blur', onPasswordChange);
      }

      if (confirmInput) {
        confirmInput.addEventListener('input', updateConfirmValidity);
        confirmInput.addEventListener('keyup', updateConfirmValidity);
        confirmInput.addEventListener('change', updateConfirmValidity);
        confirmInput.addEventListener('blur', updateConfirmValidity);
      }

      updatePasswordValidity();
      updateConfirmValidity();
      recheckSoon();
    });
  </script>
{% endblock %}

