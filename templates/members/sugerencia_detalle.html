{% extends "public/layout.html" %}

{% block title %}{{ suggestion.title }} ¬∑ Foro{% endblock %}

{% block head %}
<style>
  .comment-item {
    position: relative;
    transition: all 0.3s ease;
  }
  .comment-item.is-own {
    box-shadow: 0 0 15px rgba(34, 197, 94, 0.25);
    border-left: 4px solid #22c55e;
  }
  .comment-item.is-reply {
    margin-left: 2.5rem;
    border-left: 2px solid var(--color-border, rgba(15, 23, 42, 0.1));
    padding-left: 1rem;
  }
  .comment-actions-hover {
    position: absolute;
    bottom: 0.75rem;
    right: 0.75rem;
    display: flex;
    gap: 0.5rem;
    opacity: 0;
    transition: opacity 0.2s ease-in-out;
  }
  .comment-item:hover .comment-actions-hover {
    opacity: 1;
  }
  .comment-actions-hover form {
    margin: 0;
  }
  .action-icon-btn {
    background: white;
    border: 1px solid var(--color-border, rgba(15, 23, 42, 0.1));
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: var(--color-text-soft);
    transition: all 0.2s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  .action-icon-btn:hover {
    color: var(--color-accent-primary);
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  .edit-form-inline {
    display: none;
    margin-top: 1rem;
  }
  .reply-form-inline {
    display: none;
    margin-top: 1rem;
    margin-left: 2.5rem;
  }
  .comment-body {
    cursor: pointer;
  }
  .comment-actions {
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
    margin-top: 0.5rem;
  }
  .nav-auth-btn--cancel {
    background: #ffffff !important;
    color: #1f3ba2 !important;
    border: 1px solid #1f3ba2 !important;
  }
  .nav-auth-btn--cancel:hover {
    background: #f0f4ff !important;
    opacity: 1 !important;
  }
  .btn-mini {
    padding: 0.25rem 0.75rem !important;
    font-size: 0.85rem !important;
    min-width: 80px !important;
  }
</style>
{% endblock %}

{% block content %}
  <section class="page-section suggestion-thread">
    <div class="thread-container">
      <header class="thread-hero card gradient-bg">
        <div class="thread-headline">
          <div class="thread-hero-top">
            <p class="thread-breadcrumb">{{ breadcrumb }}</p>
            <a href="{{ back_url }}" class="thread-back">{{ back_label }}</a>
          </div>
          <div class="thread-title-row">
            <h1 class="thread-title">{{ suggestion.title }}</h1>
          </div>
          <div class="thread-stats-line">
            <div class="thread-mini-totals">
              <span class="mini-pill up" id="likes-count-hero">üëç {{ likes_count }}</span>
              <span class="mini-pill down" id="dislikes-count-hero">üëé {{ dislikes_count }}</span>
            </div>
            <span class="status-pill status-{{ suggestion.status }}">{{ suggestion.status|capitalize }}</span>
            <span class="thread-meta inline">Por {{ suggestion.creator.display_name if suggestion.creator else 'Socio' }} ¬∑ Estado {{ suggestion.status }} ¬∑ {{ total_votes }} votos totales</span>
          </div>
        </div>
      </header>

      <article class="thread-body card">
        <div class="rich-text">{{ suggestion.body_html | safe }}</div>
      </article>

      <section class="thread-comments card">
        <div class="comments-header">
          <div>
            <p class="eyebrow">Comentarios</p>
            <h3>{{ comments|length }} aportes</h3>
          </div>
        </div>
        <div class="comment-list">
          {% macro render_comment(comment, is_reply=False, is_last_overall=False) %}
            {% set is_leaf = comment.id in leaf_comment_ids %}
            <article class="comment-item {{ 'is-own' if comment.created_by == current_user.id else '' }} {{ 'is-reply' if is_reply else '' }}" id="comment-{{ comment.id }}" {% if is_last_overall %}onclick="focusMainInput(event)"{% endif %}>
              <div class="comment-meta">
                <span class="author">{{ comment.author.display_name if comment.author else 'Socio' }}</span>
                {% if comment.created_at %}
                  <span class="date">
                    {{ comment.created_at.strftime("%d/%m/%Y %H:%M") }}
                    {% if comment.is_edited %}
                      <small class="edited-label" style="opacity: 0.7; margin-left: 5px;">(Editado)</small>
                    {% endif %}
                  </span>
                {% endif %}
              </div>
              <div class="comment-content-wrapper" id="comment-body-{{ comment.id }}">
                <p class="comment-body">{{ comment.body_html }}</p>
              </div>

              {# Formulario de edici√≥n (oculto por defecto) #}
              {% if comment.created_by == current_user.id and is_leaf %}
                <div class="edit-form-inline" id="edit-form-{{ comment.id }}">
                  <form method="post" action="{{ url_for('members.editar_comentario', comment_id=comment.id) }}">
                    {{ comment_form.hidden_tag() }}
                    <textarea name="content" class="comment-textarea">{{ comment.body_html }}</textarea>
                    <div class="comment-actions">
                      <button type="button" class="nav-auth-btn nav-auth-btn--cancel btn-mini" onclick="toggleEdit('{{ comment.id }}', event)">Cancelar</button>
                      <button type="submit" class="nav-auth-btn nav-auth-btn--logout btn-mini">Guardar</button>
                    </div>
                  </form>
                </div>
              {% endif %}

              <div class="comment-actions-hover">
                {# Icono de responder #}
                {% if can_comment %}
                  <button class="action-icon-btn" title="Responder a este mensaje" onclick="showReplyForm('{{ comment.id }}', event)">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M3 10h10a8 8 0 0 1 8 8v2M3 10l6 6m-6-6l6-6"></path>
                    </svg>
                  </button>
                {% endif %}

                {# Icono de editar (solo si es el ultimo mensaje del usuario en la rama) #}
                {% if comment.created_by == current_user.id and is_leaf %}
                  <button class="action-icon-btn" title="Editar mensaje" onclick="toggleEdit('{{ comment.id }}', event)">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                  </button>
                {% endif %}

                {% if comment.created_by == current_user.id and is_leaf %}
                  <form method="post" action="{{ url_for('members.eliminar_comentario', comment_id=comment.id) }}" onsubmit="return confirm('Eliminar este comentario?');">
                    {{ comment_form.csrf_token }}
                    <button class="action-icon-btn" title="Eliminar mensaje">
                      <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18"></path>
                        <path d="M8 6V4h8v2"></path>
                        <path d="M6 6l1 14h10l1-14"></path>
                        <path d="M10 11v6"></path>
                        <path d="M14 11v6"></path>
                      </svg>
                    </button>
                  </form>
                {% endif %}
              </div>
            </article>

            {# Formulario de respuesta (oculto por defecto) #}
            {% if can_comment %}
              <div class="reply-form-inline" id="reply-form-{{ comment.id }}">
                <form method="post" action="{{ url_for('members.comentar_sugerencia', suggestion_id=suggestion.id) }}">
                  {{ comment_form.hidden_tag() }}
                  <input type="hidden" name="parent_id" value="{{ comment.id }}">
                  <textarea name="content" class="comment-textarea" placeholder="Escribe tu respuesta..."></textarea>
                  <div class="comment-actions">
                    <button type="button" class="nav-auth-btn nav-auth-btn--cancel btn-mini" onclick="showReplyForm('{{ comment.id }}', event)">Cancelar</button>
                    <button type="submit" class="nav-auth-btn nav-auth-btn--logout btn-mini">Responder</button>
                  </div>
                </form>
              </div>
            {% endif %}

            {% for child in comment.children.order_by(Comment.created_at.asc()) %}
              {{ render_comment(child, is_reply=True, is_last_overall=(child.id == comments[-1].id if comments else False)) }}
            {% endfor %}
          {% endmacro %}

          {% for comment in comments if not comment.parent_id %}
            {{ render_comment(comment, is_last_overall=(comment.id == comments[-1].id if comments else False)) }}
          {% else %}
            <p class="comment-empty">Todav√≠a no hay comentarios, s√© el primero en participar.</p>
          {% endfor %}
        </div>

        {% if can_comment %}
          <form
            method="post"
            action="{{ url_for('members.comentar_sugerencia', suggestion_id=suggestion.id) }}"
            class="comment-form"
          >
            {{ comment_form.hidden_tag() }}
            <label for="comment-content">A√±adir comentario</label>
            {{ comment_form.content(id="comment-content", class_="comment-textarea", placeholder="Comparte tu idea o duda...") }}
            <div class="comment-actions">
              {{ comment_form.submit(class_="nav-auth-btn nav-auth-btn--logout comment-submit-btn") }}
            </div>
          </form>
        {% else %}
          <p class="comment-empty">No tienes permisos para comentar.</p>
        {% endif %}
      </section>

      <section class="thread-vote card">
        <div class="vote-header">
          <div>
            <p class="eyebrow">Votar</p>
            <h3>¬øQu√© opinas?</h3>
            <p class="vote-copy">
              {% if is_closed %}
                El hilo est√° cerrado, los votos quedan fijados.
              {% else %}
                Puedes cambiar tu voto en cualquier momento mientras siga abierto.
              {% endif %}
            </p>
          </div>
        </div>
        {% if can_vote %}
        <form
          method="post"
          action="{{ url_for('members.votar_sugerencia', suggestion_id=suggestion.id) }}"
          class="vote-form"
          id="voteForm"
          data-likes="{{ likes_count }}"
          data-dislikes="{{ dislikes_count }}"
          data-current-vote="{{ user_vote.value if user_vote else '' }}"
          data-is-closed="{{ 'true' if is_closed else 'false' }}"
        >
          {{ vote_form.csrf_token }}
          {{ vote_form.value(id="voteValue") }}
          <div class="vote-actions inline">
            <button
              type="button"
              class="vote-btn up {% if user_vote and user_vote.value == 1 %}active{% endif %}"
              data-value="1"
              {% if is_closed %}disabled{% endif %}
            >
              <span class="emoji">üëç</span>
              <span>Me gusta</span>
            </button>
            <button
              type="button"
              class="vote-btn down {% if user_vote and user_vote.value == -1 %}active{% endif %}"
              data-value="-1"
              {% if is_closed %}disabled{% endif %}
            >
              <span class="emoji">üëé</span>
              <span>No me gusta</span>
            </button>
          </div>
          <div class="vote-footer">
            {% if is_closed %}
              <span class="vote-locked">Hilo cerrado: los votos ya no se pueden mover.</span>
            {% else %}
              <span class="vote-hint">Haz clic en Me gusta o No me gusta para guardar el voto al instante.</span>
            {% endif %}
          </div>
        </form>
        {% else %}
          <p class="vote-locked">No tienes permisos para votar.</p>
        {% endif %}
      </section>
    </div>
  </section>
{% endblock %}

{% block scripts %}
  <script>
    function toggleEdit(commentId, event) {
      if (event) event.stopPropagation();
      const body = document.getElementById(`comment-body-${commentId}`);
      const form = document.getElementById(`edit-form-${commentId}`);
      const article = document.getElementById(`comment-${commentId}`);
      const actions = article ? article.querySelector('.comment-actions-hover') : null;
      
      if (body && form) {
        const isEditing = form.style.display === 'block';
        form.style.display = isEditing ? 'none' : 'block';
        body.style.display = isEditing ? 'block' : 'none';
        if (actions) {
          actions.style.setProperty('display', isEditing ? 'flex' : 'none', 'important');
        }
      }
    }

    function showReplyForm(commentId, event) {
      if (event) event.stopPropagation();
      const form = document.getElementById(`reply-form-${commentId}`);
      const article = document.getElementById(`comment-${commentId}`);
      const actions = article ? article.querySelector('.comment-actions-hover') : null;

      if (form) {
        const isVisible = form.style.display === 'block';
        form.style.display = isVisible ? 'none' : 'block';
        if (actions) {
          actions.style.setProperty('display', isVisible ? 'flex' : 'none', 'important');
        }
        if (!isVisible) {
          form.querySelector('textarea').focus();
        }
      }
    }

    function focusMainInput(event) {
      // Solo si se hace click en el contenedor y no en un bot√≥n o link
      if (event.target.closest('button') || event.target.closest('a') || event.target.closest('form')) return;
      const mainTextarea = document.getElementById('comment-content');
      if (mainTextarea) {
        mainTextarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
        mainTextarea.focus();
      }
    }

    (function () {
      const form = document.getElementById('voteForm');
      if (!form) return;
      const hiddenInput = document.getElementById('voteValue');
      const buttons = Array.from(form.querySelectorAll('.vote-btn'));
      const csrf = form.querySelector('input[name="csrf_token"]')?.value;
      const isClosed = form.dataset.isClosed === 'true';
      let currentVote = form.dataset.currentVote ? parseInt(form.dataset.currentVote, 10) : null;
      let likes = parseInt(form.dataset.likes, 10) || 0;
      let dislikes = parseInt(form.dataset.dislikes, 10) || 0;

      const likesHero = document.getElementById('likes-count-hero');
      const dislikesHero = document.getElementById('dislikes-count-hero');

      const updateCounts = () => {
        if (likesHero) likesHero.textContent = `üëç ${likes}`;
        if (dislikesHero) dislikesHero.textContent = `üëé ${dislikes}`;
      };

      const syncActive = (value) => {
        buttons.forEach((btn) => {
          const isActive = parseInt(btn.dataset.value, 10) === value;
          btn.classList.toggle('active', isActive);
          btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        });
      };

      const sendVote = async (value) => {
        if (isClosed) {
          window.ampaAlert('El hilo est√° cerrado; no se pueden registrar votos.');
          return;
        }
        if (currentVote && currentVote === value) {
          return;
        }
        if (currentVote && !(await window.ampaConfirm({
          title: 'Cambiar voto',
          message: 'Ya hab√≠as votado. ¬øQuieres cambiar tu voto?',
          confirmText: 'Cambiar voto',
          cancelText: 'Cancelar',
          variant: 'warning'
        }))) {
          return;
        }
        if (!csrf) {
          window.ampaAlert('No se pudo validar la sesi√≥n. Recarga la p√°gina.');
          return;
        }
        if (hiddenInput) hiddenInput.value = value;
        const body = new FormData();
        body.append('csrf_token', csrf);
        body.append('value', String(value));
        try {
          const res = await fetch(form.action, {
            method: 'POST',
            headers: {
              'Accept': 'application/json',
              'X-Requested-With': 'XMLHttpRequest',
            },
            body,
          });
          const data = await res.json().catch(() => null);
          if (!res.ok || !data?.success) {
            window.ampaAlert(data?.message || 'No se pudo registrar el voto.');
            return;
          }
          currentVote = data.vote;
          likes = data.likes;
          dislikes = data.dislikes;
          syncActive(currentVote);
          updateCounts();
        } catch (err) {
          console.error(err);
          window.ampaAlert('No se pudo registrar el voto. Int√©ntalo de nuevo.');
        }
      };

      buttons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const value = parseInt(btn.dataset.value, 10);
          if (Number.isNaN(value)) return;
          sendVote(value);
        });
      });

      if (currentVote) {
        syncActive(currentVote);
      }
      updateCounts();
    })();
  </script>
{% endblock %}
