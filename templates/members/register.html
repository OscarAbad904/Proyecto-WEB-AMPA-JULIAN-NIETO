{% extends "public/layout.html" %}

{% block title %}Registro socios AMPA Julián Nieto{% endblock %}

{% block content %}
  <section class="private-section">
    <div class="private-container">
      <div id="registration-main-content">
        <h1 class="private-title">Registro</h1>
        <div id="registration-instructions">
          <p class="private-desc"><strong>Importante:</strong> para registrarte en la web hay que ser socio previamente.</p>
          <p class="private-desc">Si aún no eres socio, puedes solicitar el alta. Si ya eres socio, marca la casilla y regístrate en la web.</p>

          <label class="private-remember" style="margin-bottom: 0.75rem;">
            <input type="checkbox" id="already-member">
            <span>Ya soy socio</span>
          </label>

          <button type="button" class="btn-primary full" id="open-register-form">Hacerme socio</button>
        </div>

        <div id="register-form-container" {% if request.method != "POST" %}hidden{% endif %}>
          <p class="private-desc" style="margin-top: 1.25rem;">Completa tus datos. Te enviaremos un correo para verificar tu email y el AMPA aprobará el alta.</p>
          <form method="post" class="private-form" id="register-form" novalidate>
          {{ form.hidden_tag() }}
          <div class="private-field">
            {{ form.first_name.label }}
            {{ form.first_name(placeholder="Nombre", autocomplete="given-name") }}
            {% for error in form.first_name.errors %}
              <p class="form-error">{{ error }}</p>
            {% endfor %}
          </div>
          <div class="private-field">
            {{ form.last_name.label }}
            {{ form.last_name(placeholder="Apellidos", autocomplete="family-name") }}
            {% for error in form.last_name.errors %}
              <p class="form-error">{{ error }}</p>
            {% endfor %}
          </div>
          <div class="private-field">
            {{ form.email.label }}
            {{ form.email(placeholder="correo@ejemplo.com", autocomplete="email") }}
            {% for error in form.email.errors %}
              <p class="form-error">{{ error }}</p>
            {% endfor %}
          </div>
          <div class="private-field">
            {{ form.phone_number.label }}
            {{ form.phone_number(placeholder="Teléfono (opcional)", autocomplete="tel") }}
            {% for error in form.phone_number.errors %}
              <p class="form-error">{{ error }}</p>
            {% endfor %}
          </div>
          <div id="registration-message" style="display:none; margin-top: 1rem; padding: 1rem; border-radius: 0.5rem;"></div>
          <button type="button" class="btn-primary full" id="register-submit-btn">Enviar registro</button>
        </form>
      </div>
    </div> <!-- Fin de registration-main-content -->
    </div>
  </section>

  <div id="privacy-modal" class="login-modal" aria-hidden="true">
    <div class="login-modal-dialog">
      <button class="login-modal-close" type="button" aria-label="Cerrar" id="close-privacy">×</button>
      <p class="eyebrow">Privacidad</p>
      <h2>Política de privacidad</h2>
      <p class="section-subtitle">Debes leer hasta el final para poder elegir una opción.</p>

      <div id="privacy-scroll" class="privacy-scroll" tabindex="0" role="region" aria-label="Texto de la política de privacidad">
        <p><strong>Responsable</strong>: AMPA CEIP Julián Nieto Tapia.</p>
        <p><strong>Finalidad</strong>: gestionar el alta como socio/a, comunicaciones y servicios relacionados con el AMPA.</p>
        <p><strong>Datos</strong>: nombre, apellidos, email y teléfono (opcional), además de datos derivados de la gestión del alta.</p>
        <p><strong>Legitimación</strong>: consentimiento y relación asociativa.</p>
        <p><strong>Destinatarios</strong>: no se cederán datos a terceros salvo obligación legal o proveedores necesarios para el servicio (p.ej. correo electrónico) bajo contrato.</p>
        <p><strong>Conservación</strong>: durante el tiempo necesario para la gestión del alta y, en su caso, mientras exista relación como socio/a o responsabilidades legales.</p>
        <p><strong>Derechos</strong>: acceso, rectificación, supresión, oposición, limitación y portabilidad. Puedes ejercerlos contactando con el AMPA.</p>
        <p><strong>Información adicional</strong>: puedes solicitar información ampliada y el texto completo de la política al AMPA.</p>
        <hr>
        <p>Al aceptar esta política, consientes el tratamiento de tus datos para las finalidades indicadas.</p>
        <p style="margin-bottom: 0;">Fin del texto.</p>
      </div>

      <div class="modal-footer-buttons" style="display: flex; gap: 1rem; margin-top: 1.5rem;">
        <button type="button" class="btn-primary full btn-blue" id="privacy-cancel" disabled>No aceptar</button>
        <button type="button" class="btn-primary full" id="privacy-accept" disabled>Aceptar</button>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <style>
    .private-container .private-remember {
      width: 100%;
      justify-content: center;
      text-align: center;
      color: #464646;
    }

    .registration-success h2 {
      margin-bottom: 1rem;
      font-weight: 800;
    }

    .registration-success p {
      color: #4a4a4a;
      line-height: 1.6;
    }

    .privacy-scroll {
      max-height: 320px;
      overflow-y: auto;
      padding: 0.85rem 1rem;
      border-radius: 0.85rem;
      border: 1px solid var(--color-border, rgba(100, 116, 139, 0.2));
      background: rgba(255, 255, 255, 0.92);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.7), 0 10px 30px rgba(15, 23, 42, 0.08);
      line-height: 1.55;
      color: var(--color-text-base);
    }

    .privacy-scroll hr {
      border: 0;
      border-top: 1px solid rgba(100, 116, 139, 0.2);
      margin: 0.9rem 0;
    }

    .form-error {
      margin: 0.35rem 0 0;
      color: var(--color-danger, #ef4444);
      font-weight: 600;
      font-size: 0.95rem;
    }

    .btn-primary:disabled, .btn-secondary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      filter: grayscale(1);
    }

    #registration-message.success {
      background-color: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    #registration-message.error {
      background-color: #fee2e2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }

    #registration-message.info {
      background-color: #e0f2fe;
      color: #075985;
      border: 1px solid #bae6fd;
    }

    .btn-blue {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
      color: white !important;
      border: none !important;
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3) !important;
    }

    .btn-blue:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 12px 28px rgba(37, 99, 235, 0.45) !important;
    }
  </style>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const mainContent = document.getElementById('registration-main-content');
      const openFormBtn = document.getElementById('open-register-form');
      const alreadyMember = document.getElementById('already-member');
      const formContainer = document.getElementById('register-form-container');
      const registerForm = document.getElementById('register-form');
      const submitBtn = document.getElementById('register-submit-btn');
      const registrationMessage = document.getElementById('registration-message');

      const privacyModal = document.getElementById('privacy-modal');
      const privacyScroll = document.getElementById('privacy-scroll');
      const privacyAcceptBtn = document.getElementById('privacy-accept');
      const privacyCancelBtn = document.getElementById('privacy-cancel');
      const closePrivacyBtn = document.getElementById('close-privacy');

      const firstNameInput = document.getElementById('first_name');
      const lastNameInput = document.getElementById('last_name');
      const emailInput = document.getElementById('email');
      const phoneInput = document.getElementById('phone_number');

      let privacyReadToEnd = false;
      let formData = {};

      // UI Toggle for "Ya soy socio"
      function updateCtaText() {
        if (!openFormBtn || !alreadyMember) return;
        openFormBtn.textContent = alreadyMember.checked ? 'Regístrame en la WEB' : 'Hacerme socio';
      }

      alreadyMember?.addEventListener('change', updateCtaText);
      updateCtaText();

      openFormBtn?.addEventListener('click', function () {
        if (!formContainer) return;
        formContainer.hidden = false;
        formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        firstNameInput?.focus();
      });

      // Validation
      function validateEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      }

      function showMessage(text, type = 'info') {
        if (!registrationMessage) return;
        registrationMessage.textContent = text;
        registrationMessage.className = '';
        registrationMessage.classList.add(type);
        registrationMessage.style.display = 'block';
        registrationMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }

      function clearErrors() {
        document.querySelectorAll('.form-error-inline').forEach(el => el.remove());
        document.querySelectorAll('.input-invalid').forEach(el => el.classList.remove('input-invalid'));
      }

      function showError(input, message) {
        input.classList.add('input-invalid');
        const error = document.createElement('p');
        error.className = 'form-error form-error-inline';
        error.textContent = message;
        input.parentNode.appendChild(error);
      }

      function validateForm() {
        clearErrors();
        let isValid = true;

        if (!firstNameInput.value.trim()) {
          showError(firstNameInput, 'El nombre es obligatorio.');
          isValid = false;
        }
        if (!lastNameInput.value.trim()) {
          showError(lastNameInput, 'Los apellidos son obligatorios.');
          isValid = false;
        }
        if (!emailInput.value.trim()) {
          showError(emailInput, 'El email es obligatorio.');
          isValid = false;
        } else if (!validateEmail(emailInput.value.trim())) {
          showError(emailInput, 'El formato del email no es válido.');
          isValid = false;
        }

        return isValid;
      }

      // Modal Handling
      function toggleModal(show) {
        privacyModal.classList.toggle('open', show);
        privacyModal.setAttribute('aria-hidden', !show);
        if (show) {
          // Reset scroll and buttons if not already read
          if (!privacyReadToEnd) {
            privacyScroll.scrollTop = 0;
            privacyAcceptBtn.disabled = true;
            privacyCancelBtn.disabled = true;
          }
        }
      }

      submitBtn?.addEventListener('click', function () {
        if (validateForm()) {
          formData = {
            first_name: firstNameInput.value.trim(),
            last_name: lastNameInput.value.trim(),
            email: emailInput.value.trim(),
            phone_number: phoneInput.value.trim(),
            csrf_token: registerForm.querySelector('input[name="csrf_token"]').value
          };
          toggleModal(true);
        }
      });

      privacyScroll?.addEventListener('scroll', function () {
        if (privacyReadToEnd) return;
        const tolerance = 5;
        if (privacyScroll.scrollTop + privacyScroll.clientHeight >= privacyScroll.scrollHeight - tolerance) {
          privacyReadToEnd = true;
          privacyAcceptBtn.disabled = false;
          privacyCancelBtn.disabled = false;
        }
      });

      privacyCancelBtn?.addEventListener('click', function () {
        toggleModal(false);
        showMessage('Registro cancelado. Es necesario aceptar la Política de Privacidad para poder registrarse.', 'error');
      });

      closePrivacyBtn?.addEventListener('click', () => {
        toggleModal(false);
        showMessage('Debes aceptar la Política de Privacidad para completar el registro.', 'info');
      });

      privacyModal?.addEventListener('click', (e) => {
        if (e.target === privacyModal) {
          toggleModal(false);
          showMessage('Debes aceptar la Política de Privacidad para completar el registro.', 'info');
        }
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && privacyModal.classList.contains('open')) {
          toggleModal(false);
          showMessage('Debes aceptar la Política de Privacidad para completar el registro.', 'info');
        }
      });

      // AJAX Submission
      privacyAcceptBtn?.addEventListener('click', async function () {
        privacyAcceptBtn.disabled = true;
        privacyAcceptBtn.textContent = 'Enviando...';
        
        const csrfToken = registerForm.querySelector('input[name="csrf_token"]').value;

        try {
          const response = await fetch('{{ url_for("members.register") }}', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
              ...formData,
              privacy_accepted: true,
              consent_timestamp: new Date().toISOString(),
              privacy_version: '1'
            })
          });

          const result = await response.json();

          if (result.ok) {
            toggleModal(false);
            mainContent.innerHTML = `<div class="registration-success" style="text-align:center; padding: 2rem;">
              <h2 style="color: var(--color-accent);">¡Registro recibido!</h2>
              <p style="margin-bottom: 1rem;">${result.message}</p>
              <p class="private-desc" style="font-size: 0.95rem; color: #64748b;">
                <strong>Nota:</strong> Si no recibes el correo en unos minutos, por favor revisa tu carpeta de 
                <strong>Correo no deseado / Spam</strong>.
              </p>
              <a href="{{ url_for('public.home') }}" class="btn-primary" style="display:inline-block; margin-top:1.5rem; padding: 0.75rem 2rem;">Volver al inicio</a>
            </div>`;
          } else {
            privacyAcceptBtn.disabled = false;
            privacyAcceptBtn.textContent = 'Aceptar';
            toggleModal(false);
            showMessage(result.message || 'Hubo un error al procesar el registro. Inténtalo de nuevo.', 'error');
          }
        } catch (error) {
          console.error('Error:', error);
          privacyAcceptBtn.disabled = false;
          privacyAcceptBtn.textContent = 'Aceptar';
          toggleModal(false);
          showMessage('Error de conexión. Por favor, inténtalo más tarde.', 'error');
        }
      });
    });
  </script>
{% endblock %}
