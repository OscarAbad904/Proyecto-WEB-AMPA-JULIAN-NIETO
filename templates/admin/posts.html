{% extends "public/layout.html" %}

{% block title %}Tablón de noticias · Admin{% endblock %}

{% block head %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.4/dist/quill.snow.css" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}" />
{% endblock %}

{% block content %}
  <section class="admin-wrapper">
    <div class="admin-header">
      <p class="admin-kicker">Noticias · Administración</p>
      <h1 class="admin-title">Tablón de publicaciones</h1>
      <p class="admin-subtitle">Crea noticias con formato enriquecido, maquetación de imagen y previsualización en vivo con el mismo estilo del sitio.</p>
    </div>

    {# flashes rendered globally in layout #}

    <div class="admin-grid">
      <form class="admin-card admin-form" method="post" novalidate enctype="multipart/form-data">
        {% if not can_edit_posts %}
        <p class="muted" style="margin-top:0;">Solo tienes acceso de lectura. Solicita permiso de edición para modificar noticias.</p>
        {% endif %}
        <fieldset {% if not can_edit_posts %}disabled aria-disabled="true"{% endif %}>
        {{ form.csrf_token(id="csrf_posts_main") }}
        {{ form.post_id(id="post-id") }}
        <div class="field">
          {{ form.title.label }}
          {{ form.title(placeholder="Título de la noticia") }}
        </div>
        <div class="field field-row">
          <div>
            {{ form.published_at.label }}
            {{ form.published_at(type="date") }}
          </div>
          <div>
            {{ form.status.label }}
            {{ form.status() }}
          </div>
        </div>
        <div class="field field-row">
          <div>
            {{ form.category.label }}
            {{ form.category() }}
          </div>
          <div>
            {{ form.image_layout.label }}
            {{ form.image_layout() }}
          </div>
        </div>
        <div class="field field-row">
          <div>
            {{ form.cover_image.label }}
            {{ form.cover_image(placeholder="URL de la portada (Drive o web)") }}
            <small class="helper">Puedes pegar un enlace de Google Drive y lo convertiremos para mostrar la imagen.</small>
          </div>
        </div>
        <div class="field field-row">
          <div>
            {{ form.cover_image_file.label }}
            {{ form.cover_image_file(accept="image/*") }}
            <small class="helper">Si subes un archivo generaremos automáticamente las 4 variantes (últimas noticias vertical/horizontal y modal vertical/horizontal) y las subiremos a Drive.</small>
          </div>
        </div>
        <div class="field">
          {{ form.excerpt.label }}
          {{ form.excerpt(placeholder="Resumen breve para el listado") }}
        </div>
        <div class="field">
          <label>Contenido de la noticia</label>
          <div id="editor"></div>
          {{ form.content(style="display:none") }}
          <small class="helper">Negrita, cursiva, subrayado, tamaño, color, alineación, listas y enlaces disponibles.</small>
        </div>
        {{ form.submit(class="btn-primary", id="submit-post") }}
        </fieldset>
      </form>

      <aside class="admin-card preview-card">
        <div class="preview-header">
          <p class="admin-kicker">Previsualización</p>
          <div class="preview-controls">
            <button type="button" class="preview-btn active" data-view="desktop">Escritorio</button>
            <button type="button" class="preview-btn" data-view="mobile">Móvil</button>
          </div>
        </div>

        <div class="preview-viewport-container">
          <!-- Desktop Viewport -->
          <div class="viewport-wrapper view-desktop active" id="viewport-desktop">
            <div class="viewport-emulator" style="width: 1814px; height: 875px;">
              <div class="news-modal-dialog" id="preview-dialog-desktop">
                <button class="news-modal-close" type="button">×</button>
                <figure class="news-modal-cover" id="preview-figure-desktop">
                  <img id="preview-image-desktop" src="{{ style_urls.placeholder }}" alt="Portada" referrerpolicy="no-referrer" />
                </figure>
                <div class="news-modal-body">
                  <p class="news-modal-meta"><span id="preview-category-desktop">GENERAL</span> · <span id="preview-date-desktop">Fecha pendiente</span></p>
                  <h2 id="preview-title-desktop">Título de ejemplo</h2>
                  <div id="preview-content-desktop" class="ql-editor"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Mobile Viewport -->
          <div class="viewport-wrapper view-mobile" id="viewport-mobile">
            <div class="viewport-emulator" style="width: 340px; height: 759px;">
              <div class="news-modal-dialog" id="preview-dialog-mobile">
                <button class="news-modal-close" type="button">×</button>
                <figure class="news-modal-cover" id="preview-figure-mobile">
                  <img id="preview-image-mobile" src="{{ style_urls.placeholder }}" alt="Portada" referrerpolicy="no-referrer" />
                </figure>
                <div class="news-modal-body">
                  <p class="news-modal-meta"><span id="preview-category-mobile">GENERAL</span> · <span id="preview-date-mobile">Fecha pendiente</span></p>
                  <h2 id="preview-title-mobile">Título de ejemplo</h2>
                  <div id="preview-content-mobile" class="ql-editor"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </aside>
    </div>

    <div class="admin-card list-card">
      <div class="field-row" style="align-items:center;">
        <h2 style="margin:0;">Noticias</h2>
        <div style="margin-left:auto; display:flex; gap:0.6rem; align-items:center; width:100%; justify-content:flex-end;">
          <input type="search" id="post-search" class="post-search" placeholder="Buscar por título, categoría o fecha" />
        </div>
      </div>
      <div class="post-list">
        {% if posts %}
          {% for post in posts %}
            <article
              class="post-row"
              data-layout="{{ post.tags or 'full' }}"
              data-id="{{ post.id }}"
              data-title="{{ post.title }}"
              data-status="{{ post.status }}"
              data-cover="{{ post.cover_image or '' }}"
              data-date="{{ post.published_at.strftime('%Y-%m-%d') if post.published_at else '' }}"
              data-excerpt="{{ post.excerpt or '' }}"
              data-content='{{ post.body_html|tojson }}'
              data-category="{{ post.category or 'general' }}"
            >
              <div class="post-thumb">
                <img src="{{ post.cover_image or style_urls.placeholder }}" alt="Portada" referrerpolicy="no-referrer" />
              </div>
              <div>
                <div style="display:flex; align-items:center; gap:0.4rem; flex-wrap:wrap; justify-content:space-between;">
                  <div style="display:flex; align-items:center; gap:0.4rem; flex-wrap:wrap;">
                    <span class="chip {% if post.status == 'published' %}chip-live{% endif %}">{{ 'Publicada' if post.status == 'published' else 'Borrador' }}</span>
                    <span class="muted">{{ post.published_at.strftime('%d/%m/%Y') if post.published_at else 'Sin fecha' }}</span>
                    <span class="muted">·</span>
                    <span class="muted">{{ post.tags or 'full' }}</span>
                  </div>
                  <form class="delete-post-form" method="post" action="{{ url_for('admin.delete_post', post_id=post.id) }}" style="margin-left:auto;">
                    {{ form.csrf_token(id="csrf_delete_" ~ post.id) }}
                    <button type="submit" class="delete-post-btn" aria-label="Eliminar noticia">Eliminar</button>
                  </form>
                </div>
                <h3>{{ post.title }}</h3>
                <p>{{ (post.excerpt or '')[:120] }}{% if (post.excerpt or '')|length > 120 %}…{% endif %}</p>
              </div>
            </article>
          {% endfor %}
        {% else %}
          <p class="muted">Todavía no hay noticias creadas.</p>
        {% endif %}
      </div>
    </div>
  </section>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.4/dist/quill.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const editorEl = document.getElementById('editor');
      const hiddenContent = document.querySelector('textarea[name="{{ form.content.name }}"]');
      
      // Preview Elements - Desktop
      const previewContentD = document.getElementById('preview-content-desktop');
      const previewTitleD = document.getElementById('preview-title-desktop');
      const previewImageD = document.getElementById('preview-image-desktop');
      const previewCategoryD = document.getElementById('preview-category-desktop');
      const previewDateD = document.getElementById('preview-date-desktop');
      const previewDialogD = document.getElementById('preview-dialog-desktop');
      const previewFigureD = document.getElementById('preview-figure-desktop');

      // Preview Elements - Mobile
      const previewContentM = document.getElementById('preview-content-mobile');
      const previewTitleM = document.getElementById('preview-title-mobile');
      const previewImageM = document.getElementById('preview-image-mobile');
      const previewCategoryM = document.getElementById('preview-category-mobile');
      const previewDateM = document.getElementById('preview-date-mobile');
      const previewDialogM = document.getElementById('preview-dialog-mobile');
      const previewFigureM = document.getElementById('preview-figure-mobile');

      const titleInput = document.querySelector('input[name="{{ form.title.name }}"]');
      const coverInput = document.querySelector('input[name="{{ form.cover_image.name }}"]');
      const coverFileInput = document.querySelector('input[name="{{ form.cover_image_file.name }}"]');
      const statusSelect = document.querySelector('select[name="{{ form.status.name }}"]');
      const dateInput = document.querySelector('input[name="{{ form.published_at.name }}"]');
      const layoutSelect = document.querySelector('select[name="{{ form.image_layout.name }}"]');
      const defaultImage = "{{ style_urls.placeholder }}";
      const categorySelect = document.querySelector('select[name="{{ form.category.name }}"]');
      const submitBtn = document.querySelector('input[name="{{ form.submit.name }}"]');
      const postIdInput = document.getElementById('post-id');
      const searchInput = document.getElementById('post-search');
      const formEl = document.querySelector('.admin-form');
      let currentPostId = '';

      // View Switching
      const previewBtns = document.querySelectorAll('.preview-btn');
      const viewports = document.querySelectorAll('.viewport-wrapper');

      previewBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          previewBtns.forEach(b => b.classList.remove('active'));
          viewports.forEach(v => {
            v.classList.remove('active');
            v.style.display = 'none';
          });
          btn.classList.add('active');
          const view = btn.dataset.view;
          const activeViewport = document.getElementById(`viewport-${view}`);
          activeViewport.classList.add('active');
          activeViewport.style.display = 'flex';
          updateScaling();
        });
      });

      function updateScaling() {
        const container = document.querySelector('.preview-viewport-container');
        if (!container) return;
        
        const containerWidth = container.clientWidth - 40;
        const containerHeight = container.clientHeight - 40;

        document.querySelectorAll('.viewport-wrapper.active').forEach(wrapper => {
          const emu = wrapper.querySelector('.viewport-emulator');
          const targetWidth = parseInt(emu.style.width);
          const targetHeight = parseInt(emu.style.height);
          
          const scaleX = containerWidth / targetWidth;
          const scaleY = containerHeight / targetHeight;
          const scale = Math.min(scaleX, scaleY, 1); // Allow up to 1:1 if it fits

          emu.style.transform = `scale(${scale})`;
          
          // Force the wrapper to take only the scaled space to avoid pushing the grid
          wrapper.style.width = `${targetWidth * scale}px`;
          wrapper.style.height = `${targetHeight * scale}px`;
        });
      }

      window.addEventListener('resize', updateScaling);
      setTimeout(updateScaling, 100);

      const drivePatterns = [
        /https?:\/\/drive\.google\.com\/file\/d\/([^/]+)\//,
        /https?:\/\/drive\.google\.com\/file\/d\/([^/]+)\/view/,
        /https?:\/\/drive\.google\.com\/open\?id=([^&]+)/,
        /https?:\/\/drive\.google\.com\/uc\?id=([^&]+)/,
        /https?:\/\/drive\.googleusercontent\.com\/d\/([^/]+)/,
        /https?:\/\/drive\.google\.com\/uc\?export=view&?id=([^&]+)/,
      ];

      const toolbarConfig = [
        [{ header: [1, 2, 3, false] }],
        [{ size: [] }, { color: [] }, { background: [] }],
        ['bold', 'italic', 'underline'],
        [{ list: 'ordered' }, { list: 'bullet' }],
        [{ align: [] }],
        ['link', 'clean']
      ];

      let quill = null;
      if (window.Quill && editorEl) {
        quill = new Quill(editorEl, {
          theme: 'snow',
          placeholder: 'Escribe la noticia con el estilo que quieras...',
          modules: { toolbar: toolbarConfig }
        });
      }

      if (!quill && hiddenContent) {
        hiddenContent.style.display = 'block';
        hiddenContent.style.minHeight = '200px';
        hiddenContent.style.background = 'rgba(15,23,42,0.6)';
        hiddenContent.style.color = '#f8fafc';
        hiddenContent.style.borderRadius = '10px';
        hiddenContent.placeholder = hiddenContent.placeholder || 'Contenido de la noticia';
      }

      function extractDriveId(url) {
        if (!url || !url.includes('drive.google.com')) return null;
        for (const pattern of drivePatterns) {
          const match = url.match(pattern);
          if (match && match[1]) {
            return match[1];
          }
        }
        try {
          const u = new URL(url);
          const id = u.searchParams.get('id');
          if (id) return id;
        } catch (e) {
          // ignore parse errors
        }
        return null;
      }

      function normalizeDriveUrl(url) {
        const id = extractDriveId(url);
        if (id) return { url: `https://drive.google.com/uc?export=view&id=${id}`, id };
        return url;
      }

      function addDriveFallback(imgEl) {
        imgEl?.addEventListener('error', () => {
          const driveId = imgEl.dataset.driveId;
          if (driveId && imgEl.dataset.fallbackApplied !== 'thumb') {
            imgEl.dataset.fallbackApplied = 'thumb';
            imgEl.src = `https://drive.google.com/thumbnail?id=${driveId}&sz=w1200`;
            return;
          }
          if (driveId && imgEl.dataset.fallbackApplied !== 'alt') {
            imgEl.dataset.fallbackApplied = 'alt';
            imgEl.src = `https://lh3.googleusercontent.com/d/${driveId}=w1200`;
            return;
          }
          imgEl.src = defaultImage;
        });
      }

      function setImageWithFallback(imgEl, rawUrl) {
        if (!imgEl) return;
        const normalizedResult = normalizeDriveUrl(rawUrl);
        const normalized = typeof normalizedResult === 'string' ? normalizedResult : normalizedResult.url;
        const driveId = typeof normalizedResult === 'object' && normalizedResult.id ? normalizedResult.id : extractDriveId(rawUrl);
        imgEl.dataset.driveId = driveId || '';
        imgEl.dataset.fallbackApplied = '';
        imgEl.src = '';
        imgEl.src = normalized || defaultImage;
      }

      const getContentHtml = () => {
        if (quill) return quill.root.innerHTML.trim();
        return (hiddenContent?.value || '').trim();
      };

      function setSubmitLabel(isEdit) {
        if (!submitBtn) return;
        submitBtn.value = isEdit ? 'Actualizar publicación' : 'Publicar noticia';
      }

      function setCurrentPostId(idValue) {
        currentPostId = idValue || '';
        if (postIdInput) postIdInput.value = currentPostId;
        setSubmitLabel(!!currentPostId);
      }

      function applySearch() {
        const term = (searchInput?.value || '').toLowerCase().trim();
        document.querySelectorAll('.post-row').forEach((row) => {
          const text = [
            row.dataset.title,
            row.dataset.excerpt,
            row.dataset.category,
            row.dataset.date
          ].join(' ').toLowerCase();
          row.style.display = term ? (text.includes(term) ? '' : 'none') : '';
        });
      }

      function syncContent() {
        const html = getContentHtml();
        if (hiddenContent) hiddenContent.value = html;
        const placeholder = '<p>El contenido enriquecido aparecerá aquí.</p>';
        if (previewContentD) previewContentD.innerHTML = html || placeholder;
        if (previewContentM) previewContentM.innerHTML = html || placeholder;
      }

      quill?.on('text-change', syncContent);
      hiddenContent?.addEventListener('input', syncContent);

      function updateTitle() {
        const val = (titleInput?.value || 'Título de ejemplo');
        if (previewTitleD) previewTitleD.textContent = val;
        if (previewTitleM) previewTitleM.textContent = val;
      }
      titleInput?.addEventListener('input', updateTitle);

      function updateCategory() {
        const val = (categorySelect?.value || 'GENERAL').toUpperCase();
        if (previewCategoryD) previewCategoryD.textContent = val;
        if (previewCategoryM) previewCategoryM.textContent = val;
      }
      categorySelect?.addEventListener('change', updateCategory);

      function previewLocalFile(file) {
        if (!file || !file.type?.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          [previewImageD, previewImageM].forEach(img => {
            if (!img) return;
            img.dataset.driveId = '';
            img.dataset.fallbackApplied = '';
            img.src = e.target?.result || '';
          });
        };
        reader.readAsDataURL(file);
      }

      function updateCover() {
        const localFile = coverFileInput?.files && coverFileInput.files[0];
        if (localFile) {
          previewLocalFile(localFile);
          return;
        }
        let url = coverInput?.value.trim() || '';
        const isHttp = /^https?:\/\//i.test(url);
        if (url && isHttp) {
          const normalizedResult = normalizeDriveUrl(url);
          const normalized = typeof normalizedResult === 'string' ? normalizedResult : normalizedResult.url;
          const driveId = typeof normalizedResult === 'object' && normalizedResult.id ? normalizedResult.id : extractDriveId(url);
          if (normalized !== url && coverInput) coverInput.value = normalized;
          
          [previewImageD, previewImageM].forEach(img => {
            if (!img) return;
            img.dataset.fallbackApplied = '';
            img.src = '';
            img.src = normalized;
            img.dataset.driveId = driveId || '';
          });
        } else {
          if (previewImageD) previewImageD.src = defaultImage;
          if (previewImageM) previewImageM.src = defaultImage;
        }
      }

      coverInput?.addEventListener('input', updateCover);
      coverInput?.addEventListener('blur', updateCover);
      coverFileInput?.addEventListener('change', () => {
        const file = coverFileInput.files && coverFileInput.files[0];
        if (file) {
          if (coverInput) coverInput.value = '';
          previewLocalFile(file);
        } else {
          updateCover();
        }
      });
      addDriveFallback(previewImageD);
      addDriveFallback(previewImageM);

      function updateStatus() {
        // Status is not explicitly shown in the modal preview but we keep the logic if needed
      }
      statusSelect?.addEventListener('change', updateStatus);

      function updateDate() {
        const val = dateInput?.value ? dateInput.value.split('-').reverse().join('/') : 'Fecha pendiente';
        if (previewDateD) previewDateD.textContent = val;
        if (previewDateM) previewDateM.textContent = val;
      }
      dateInput?.addEventListener('change', updateDate);

      function updateLayout() {
        const layout = layoutSelect?.value || 'full';
        
        // Desktop layout
        if (previewDialogD) {
          previewDialogD.classList.remove('layout-left', 'layout-right', 'layout-none', 'layout-full', 'layout-bottom');
          previewDialogD.classList.add(`layout-${layout}`);
        }
        if (previewFigureD) {
          previewFigureD.style.display = layout === 'none' ? 'none' : 'flex';
        }

        // Mobile layout is always stacked (handled by CSS)
        if (previewFigureM) {
          previewFigureM.style.display = layout === 'none' ? 'none' : 'flex';
        }
      }
      layoutSelect?.addEventListener('change', updateLayout);

      function loadPostFromRow(row) {
        if (!row) return;
        const data = row.dataset;
        const content = data.content ? JSON.parse(data.content) : '';
        const dateValue = data.date || '';
        const statusValue = data.status || 'draft';
        const layoutValue = data.layout || 'full';

        setCurrentPostId(data.id || '');
        if (coverFileInput) coverFileInput.value = '';
        if (titleInput) titleInput.value = data.title || '';
        if (coverInput) coverInput.value = data.cover || '';
        if (statusSelect) statusSelect.value = statusValue;
        if (categorySelect) categorySelect.value = data.category || 'general';
        if (layoutSelect) layoutSelect.value = layoutValue;
        if (dateInput) dateInput.value = dateValue;
        const excerptField = document.querySelector('textarea[name="{{ form.excerpt.name }}"]');
        if (excerptField) excerptField.value = data.excerpt || '';

        if (quill) {
          quill.root.innerHTML = content || '';
        } else if (hiddenContent) {
          hiddenContent.value = content || '';
        }

        syncContent();
        updateTitle();
        updateCover();
        updateStatus();
        updateDate();
        updateLayout();
        updateCategory();
        setSubmitLabel(true);
      }

      function refreshThumbs() {
        document.querySelectorAll('.post-thumb img').forEach((imgEl) => {
          const cover = imgEl.closest('[data-cover]')?.dataset.cover || imgEl.getAttribute('src') || defaultImage;
          addDriveFallback(imgEl);
          setImageWithFallback(imgEl, cover);
        });
      }

      document.querySelectorAll('.post-row').forEach((row) => {
        row.addEventListener('click', () => loadPostFromRow(row));
        row.style.cursor = 'pointer';
      });

      document.querySelectorAll('.delete-post-form').forEach((form) => {
        form.addEventListener('click', (e) => e.stopPropagation());
      });

      searchInput?.addEventListener('input', applySearch);
      formEl?.addEventListener('submit', () => {
        setCurrentPostId(postIdInput?.value || currentPostId);
      });

      syncContent();
      updateTitle();
      updateCover();
      updateStatus();
      updateDate();
      updateLayout();
      setCurrentPostId(postIdInput?.value || '');
      applySearch();
      refreshThumbs();
    });
  </script>
{% endblock %}
