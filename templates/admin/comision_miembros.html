{% extends "public/layout.html" %}

{% block title %}Miembros | {{ commission.name }}{% endblock %}

{% set is_member_view = is_member_view|default(false) %}
{% set back_href = back_href|default(url_for('admin.commissions_index')) %}
{% set back_label = back_label|default("Volver") %}
{% set header_kicker = header_kicker|default("Comisiones") %}
{% set can_delete_members = can_delete_members if can_delete_members is defined else False %}

{% block head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}" />
  <style>
    .admin-wrapper > .admin-card {
      margin-bottom: 1rem;
    }
    .admin-wrapper > .admin-card:last-of-type {
      margin-bottom: 0;
    }
    .admin-kicker-row {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 0.35rem;
      flex-wrap: wrap;
    }
    .admin-kicker-row .nav-auth-btn {
      min-width: 0;
    }
    .field-row--member {
      align-items: end;
      grid-template-columns: minmax(220px, 1.2fr) minmax(220px, 1fr) auto;
    }
    .field-row--member .field--submit {
      display: flex;
      align-items: end;
      justify-content: flex-end;
    }
    .field-row--member .field--submit .btn-primary {
      width: auto;
      min-width: 160px;
    }
    .btn-primary--member-add {
      background: #ff8a4c;
      color: #fff;
      border-radius: 999px;
      box-shadow: 0 14px 30px rgba(255, 138, 76, 0.35);
    }
    .field-row--member .field--submit .btn-primary--member-add {
      background: #ff8a4c;
      color: #fff;
      border: none;
      border-radius: 999px;
      box-shadow: 0 14px 30px rgba(255, 138, 76, 0.35);
    }
    .btn-primary--member-add:hover {
      opacity: 0.9;
      transform: none;
    }
    .member-row-selectable {
      cursor: pointer;
      transition: background 0.15s ease;
    }
    .member-row-selectable:hover {
      background: #f8fafc;
    }
    .btn-danger {
      background: rgba(239, 68, 68, 0.12) !important;
      color: #b91c1c !important;
      border: 1px solid rgba(239, 68, 68, 0.25) !important;
    }
    .btn-danger:hover {
      background: rgba(239, 68, 68, 0.2) !important;
    }

    /* Responsive: formulario en filas en móvil */
    @media (max-width: 640px) {
      .field-row--member {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      .field-row--member .field--submit {
        justify-content: stretch;
      }
      .field-row--member .field--submit .btn-primary {
        width: 100%;
      }
    }
  </style>
{% endblock %}

{% block content %}
<section class="admin-wrapper">
  <div class="admin-header">
    <div class="admin-kicker-row">
      <p class="admin-kicker">{{ header_kicker }}</p>
      {% if back_href %}
      <a class="nav-auth-btn nav-auth-btn--logout" href="{{ back_href }}">{{ back_label }}</a>
      {% endif %}
    </div>
    <h1 class="admin-title">Miembros de {{ commission.name }}</h1>
    <p class="admin-subtitle">Añade responsables, define su rol y activa o desactiva miembros según su participación.</p>
  </div>

  <div class="admin-card">
    <form method="post" class="admin-form">
      {{ form.hidden_tag() }}
      <div class="field-row field-row--member">
        <div class="field">
          {{ form.user_id.label }}
          {{ form.user_id() }}
        </div>
        <div class="field">
          {{ form.role.label }}
          {{ form.role() }}
        </div>
        <div class="field field--submit">
          {{ form.submit(class="btn-primary btn-primary--member-add", id="member-submit") }}
        </div>
      </div>
    </form>
  </div>

  <div class="admin-card">
    <div class="table-responsive">
      <table class="admin-table">
        <thead>
          <tr>
            <th>Usuario</th>
            <th>Rol</th>
            <th>Estado</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for member in members_active %}
          <tr
            class="member-row-selectable"
            data-member-row
            data-user-id="{{ member.user.id }}"
            data-user-name="{{ member.user.display_name }}"
            data-role="{{ (member.role or 'miembro')|lower }}"
          >
            <td>{{ member.user.display_name }}</td>
            <td>{{ member.role }}</td>
            <td>
              <span class="chip chip-live">Activo</span>
            </td>
            <td>
              {% if is_member_view %}
              <form method="post" action="{{ url_for('members.commission_member_disable', slug=commission.slug, membership_id=member.id) }}">
              {% else %}
              <form method="post" action="{{ url_for('admin.commission_member_disable_admin', commission_id=commission.id, membership_id=member.id) }}">
              {% endif %}
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="nav-auth-btn nav-auth-btn--logout btn-mini">Desactivar</button>
              </form>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="4" class="muted">Sin miembros.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="admin-card">
    <h3 style="margin: 0 0 0.85rem;">Histórico</h3>
    <div class="table-responsive">
      <table class="admin-table">
        <thead>
          <tr>
            <th>Usuario</th>
            <th>Rol</th>
            <th>Estado</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for member in members_history %}
          <tr>
            <td>{{ member.user.display_name }}</td>
            <td>{{ member.role }}</td>
            <td>
              {% if member.user.deleted_at %}
                <span class="chip chip-off">Eliminado</span>
              {% elif not member.user.is_active %}
                <span class="chip chip-off">Usuario desactivado</span>
              {% elif not member.is_active %}
                <span class="chip chip-off">Desactivado en comisión</span>
              {% else %}
                <span class="chip chip-live">Activo</span>
              {% endif %}
            </td>
            <td>
              {% if member.user and member.user.is_active and member.user.deleted_at is none and not member.is_active %}
                {% if is_member_view %}
                <form method="post" action="{{ url_for('members.commission_member_reactivate', slug=commission.slug, membership_id=member.id) }}" style="display:inline;">
                {% else %}
                <form method="post" action="{{ url_for('admin.commission_member_reactivate_admin', commission_id=commission.id, membership_id=member.id) }}" style="display:inline;">
                {% endif %}
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit" class="nav-auth-btn nav-auth-btn--logout btn-mini">Reactivar</button>
                </form>
              {% endif %}
              {% if can_delete_members and not is_member_view %}
                <button type="button" class="nav-auth-btn nav-auth-btn--logout btn-mini btn-danger" onclick="confirmDeleteMember({{ member.id }}, '{{ member.user.display_name | e }}')">Eliminar</button>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="4" class="muted">Sin histórico.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {% if can_delete_members and not is_member_view %}
  <!-- Formulario oculto para eliminar miembros permanentemente -->
  <form id="delete-member-form" method="post" action="" style="display:none;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  </form>
  {% endif %}
</section>
<script>
  {% if can_delete_members and not is_member_view %}
  // Función global para confirmar eliminación de miembro
  window.confirmDeleteMember = function(membershipId, memberName) {
    window.ampaConfirm({
      title: 'Eliminar miembro permanentemente',
      message: `¿Estás seguro de que quieres eliminar permanentemente a "${memberName}" de esta comisión? Esta acción no se puede deshacer.`,
      confirmText: 'Eliminar',
      cancelText: 'Cancelar',
      variant: 'danger'
    }).then(function(confirmed) {
      if (confirmed) {
        const form = document.getElementById('delete-member-form');
        form.action = "{{ url_for('admin.commission_member_delete_admin', commission_id=commission.id, membership_id=0) }}".replace('/0', '/' + membershipId);
        form.submit();
      }
    });
  };
  {% endif %}

  (function () {
    const form = document.querySelector('.admin-form');
    if (!form) return;
    const userSelect = form.querySelector('select[name="user_id"]');
    const roleSelect = form.querySelector('select[name="role"]');
    const submitBtn = form.querySelector('#member-submit');
    const rows = document.querySelectorAll('[data-member-row]');
    if (!userSelect || !roleSelect || !rows.length || !submitBtn) return;

    let tempOption = userSelect.querySelector('option[data-temp="member"]');
    const addLabel = 'Agregar miembro';
    const updateLabel = 'Actualizar Miembro';

    const setSubmitLabel = (label) => {
      if (submitBtn.tagName === 'INPUT') {
        submitBtn.value = label;
      } else {
        submitBtn.textContent = label;
      }
    };

    const selectMember = (row) => {
      const userId = row.dataset.userId;
      const userName = row.dataset.userName || '';
      const role = row.dataset.role || 'miembro';
      if (!userId) return;

      let option = Array.from(userSelect.options).find((opt) => opt.value === userId);
      if (!option) {
        if (!tempOption) {
          tempOption = document.createElement('option');
          tempOption.dataset.temp = 'member';
          tempOption.hidden = true;
          userSelect.appendChild(tempOption);
        }
        tempOption.value = userId;
        tempOption.textContent = userName;
        option = tempOption;
      }
      userSelect.value = option.value;
      roleSelect.value = role;
      setSubmitLabel(updateLabel);
    };

    rows.forEach((row) => {
      row.addEventListener('click', (event) => {
        if (event.target.closest('form') || event.target.closest('button') || event.target.closest('a')) {
          return;
        }
        selectMember(row);
      });
    });

    userSelect.addEventListener('change', () => {
      if (tempOption && userSelect.value !== tempOption.value) {
        tempOption.remove();
        tempOption = null;
      }
      setSubmitLabel(addLabel);
    });
  })();
</script>
{% endblock %}
