{% extends "public/layout.html" %}

{% block title %}Miembros | {{ commission.name }}{% endblock %}

{% set is_member_view = is_member_view|default(false) %}
{% set back_href = back_href|default(url_for('admin.commissions_index')) %}
{% set back_label = back_label|default("Volver") %}
{% set header_kicker = header_kicker|default("Comisiones") %}

{% block head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}" />
{% endblock %}

{% block content %}
<section class="admin-wrapper">
  <div class="admin-header">
    <p class="admin-kicker">{{ header_kicker }}</p>
    <h1 class="admin-title">Miembros de {{ commission.name }}</h1>
    <p class="admin-subtitle">Añade responsables, define su rol y activa o desactiva miembros según su participación.</p>
  </div>

  <div class="admin-card">
    <form method="post" class="admin-form">
      {{ form.hidden_tag() }}
      <div class="field-row">
        <div class="field">
          {{ form.user_id.label }}
          {{ form.user_id() }}
        </div>
        <div class="field">
          {{ form.role.label }}
          {{ form.role() }}
        </div>
      </div>
      <div class="field">
        <label class="checkbox-inline">
          {{ form.is_active() }} <span>Activo</span>
        </label>
      </div>
      <div class="admin-actions">
        {{ form.submit(class="btn-primary") }}
        <a class="btn-link" href="{{ back_href }}">{{ back_label }}</a>
      </div>
    </form>
  </div>

  <div class="admin-card">
    <div class="table-responsive">
      <table class="admin-table">
        <thead>
          <tr>
            <th>Usuario</th>
            <th>Rol</th>
            <th>Estado</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for member in members_active %}
          <tr>
            <td>{{ member.user.display_name }}</td>
            <td>{{ member.role }}</td>
            <td>
              <span class="chip chip-live">Activo</span>
            </td>
            <td>
              {% if is_member_view %}
              <form method="post" action="{{ url_for('members.commission_member_disable', slug=commission.slug, membership_id=member.id) }}">
              {% else %}
              <form method="post" action="{{ url_for('admin.commission_member_disable_admin', commission_id=commission.id, membership_id=member.id) }}">
              {% endif %}
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn-link">Desactivar</button>
              </form>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="4" class="muted">Sin miembros.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="admin-card">
    <h3 style="margin: 0 0 0.85rem;">Histórico</h3>
    <div class="table-responsive">
      <table class="admin-table">
        <thead>
          <tr>
            <th>Usuario</th>
            <th>Rol</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          {% for member in members_history %}
          <tr>
            <td>{{ member.user.display_name }}</td>
            <td>{{ member.role }}</td>
            <td>
              {% if member.user.deleted_at %}
                <span class="chip chip-off">Eliminado</span>
              {% elif not member.user.is_active %}
                <span class="chip chip-off">Usuario desactivado</span>
              {% elif not member.is_active %}
                <span class="chip chip-off">Desactivado en comisión</span>
              {% else %}
                <span class="chip chip-live">Activo</span>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="3" class="muted">Sin histórico.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>
{% endblock %}
