{% extends "public/layout.html" %}

{% block title %}Permisos por rol{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}" />
  <style>
    .permissions-grid { margin-top: 1rem; display:flex; flex-direction:column; gap: 1rem; }
    .permissions-table th, .permissions-table td { text-align: center; }
    .permissions-table th:first-child, .permissions-table td:first-child { text-align: left; }
    .permissions-table small { color:#64748b; display:block; }
    .permissions-actions { display:flex; gap:0.75rem; flex-wrap:wrap; margin-top: 1rem; }
    .permissions-actions .btn-primary { width:auto; min-width: 180px; }
    .permissions-table th div { white-space: normal; }
    .perm-section-title { margin:0 0 0.35rem; color:#0f172a; letter-spacing:0.08em; font-size: 0.85rem; text-transform: uppercase; }
    .perm-section-desc { margin:0 0 0.4rem; color:#475569; }
    .role-col { min-width: 120px; }
    .public-col { min-width: 110px; }
  </style>
{% endblock %}

{% block content %}
<section class="admin-wrapper">
  <div class="admin-header">
    <p class="admin-kicker">Configuración · Administración</p>
    <h1 class="admin-title">Permisos por rol</h1>
    <p class="admin-subtitle">Activa o desactiva permisos disponibles para cada rol de la plataforma.</p>
  </div>

  <form method="post" class="permissions-grid">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    {% if grouped_permissions %}
      {% for section, perms in grouped_permissions %}
      {% set public_only_section = perms|selectattr('public_only')|list|length == perms|length %}
      <div class="admin-card">
        <p class="perm-section-title">{{ section }}</p>
        <p class="perm-section-desc">
          {% if public_only_section %}
            Activa o desactiva si esta secci&oacute;n es p&uacute;blica.
          {% else %}
            Marca qu&eacute; roles pueden ver o gestionar esta secci&oacute;n.
          {% endif %}
        </p>
        <div class="table-responsive">
          <table class="admin-table permissions-table">
            <thead>
              <tr>
                <th style="min-width: 220px;">Permiso</th>
                {% if not public_only_section %}
                {% for role in roles %}
                <th class="role-col">{{ role.name }}</th>
                {% endfor %}
                {% endif %}
                {% if supports_public_permissions %}
                <th class="role-col public-col">Público</th>
                {% endif %}
              </tr>
            </thead>
            <tbody>
              {% for item in perms %}
              {% set perm = item.permission %}
              {% set is_public = (perm.is_public if perm.is_public is not none else False) if supports_public_permissions else False %}
              {% set checked = None %}
              <tr>
                <td>
                  <strong>{{ item.label }}</strong>
                  {% if item.description %}<small>{{ item.description }}</small>{% endif %}
                </td>
                {% if not public_only_section %}
                {% for role in roles %}
                {% set checked = existing.get((role.id, perm.id), False) %}
                <td>
                  <label class="checkbox-inline" style="justify-content:center;" aria-label="{{ item.label }} para {{ role.name }}">
                    <input
                      type="checkbox"
                      name="perm_{{ role.id }}_{{ perm.id }}"
                      data-permission-id="{{ perm.id }}"
                      data-role-permission="1"
                      {% if checked and not is_public %}checked{% endif %}
                      {% if is_public or not can_edit_permissions %}disabled{% endif %}
                    >
                  </label>
                </td>
                {% endfor %}
                {% endif %}
                {% if supports_public_permissions %}
                <td>
                  <label class="checkbox-inline" style="justify-content:center;" aria-label="{{ item.label }} público">
                    <input
                      type="checkbox"
                      name="public_{{ perm.id }}"
                      class="public-toggle"
                      data-permission-id="{{ perm.id }}"
                      {% if is_public %}checked{% endif %}
                      {% if not can_edit_permissions %}disabled{% endif %}
                    >
                  </label>
                </td>
                {% endif %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div class="admin-card">
        <p class="muted" style="margin:0;">No hay permisos definidos en el sistema.</p>
      </div>
    {% endif %}
    {% if can_edit_permissions %}
    <div class="permissions-actions">
      <button type="submit" class="btn-primary">Guardar cambios</button>
      <a class="btn-primary btn-primary--blue" href="{{ url_for('admin.dashboard_admin') }}">Cancelar</a>
    </div>
    {% else %}
    <p class="muted" style="margin:0 0 1rem;">Solo tienes acceso de lectura. Solicita el permiso "Gestionar permisos" para editar esta tabla.</p>
    {% endif %}
  </form>
</section>

{% if can_edit_permissions %}
{% if supports_public_permissions %}
<script>
  (function () {
    const publicToggles = Array.from(document.querySelectorAll("input.public-toggle[data-permission-id]"));

    function getRoleCheckboxes(permissionId) {
      return Array.from(
        document.querySelectorAll(`input[type="checkbox"][data-role-permission="1"][data-permission-id="${permissionId}"]`)
      );
    }

    function setPublicState(permissionId, isPublic) {
      const roleCheckboxes = getRoleCheckboxes(permissionId);
      for (const checkbox of roleCheckboxes) {
        if (isPublic) checkbox.checked = false;
        checkbox.disabled = isPublic;
      }
    }

    for (const toggle of publicToggles) {
      const permissionId = toggle.getAttribute("data-permission-id");
      setPublicState(permissionId, toggle.checked);

      toggle.addEventListener("change", () => {
        setPublicState(permissionId, toggle.checked);
      });
    }

    const roleCheckboxes = Array.from(
      document.querySelectorAll('input[type="checkbox"][data-role-permission="1"][data-permission-id]')
    );

    for (const checkbox of roleCheckboxes) {
      checkbox.addEventListener("change", () => {
        if (!checkbox.checked) return;
        const permissionId = checkbox.getAttribute("data-permission-id");
        const publicToggle = document.querySelector(`input.public-toggle[data-permission-id="${permissionId}"]`);
        if (publicToggle && publicToggle.checked) {
          publicToggle.checked = false;
          setPublicState(permissionId, false);
        }
      });
    }
  })();
</script>
{% endif %}
{% endif %}
{% endblock %}
