{% extends "public/layout.html" %}

{% block title %}Comisiones | Admin{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}" />
  <style>
    .commission-admin { padding-bottom: 4rem; }

    .commission-top { display:flex; gap: 1rem; align-items:center; justify-content:flex-end; flex-wrap:wrap; margin-bottom: 1.25rem; }
    .commission-top .btn-primary { width:auto; min-width: 190px; }

    .commission-grid { margin-top: 1rem; display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1rem; }

    .commission-card { display:flex; flex-direction:column; gap: 0.75rem; text-decoration:none; color: inherit; transition: transform .12s ease, box-shadow .2s ease, border-color .2s ease; }
    .commission-card:hover { transform: translateY(-1px); border-color: rgba(139,92,246,0.35); box-shadow: 0 18px 38px rgba(15,23,42,0.16); }

    .commission-card-head { display:flex; align-items:flex-start; justify-content:space-between; gap: 0.75rem; }
    .commission-title { margin: 0; letter-spacing: -0.02em; font-size: 1.15rem; color: #0f172a; }
    .commission-head-right { display:flex; align-items:center; gap: 0.6rem; }
    .commission-date { white-space:nowrap; }

    .commission-desc { margin:0; color:#475569; line-height: 1.5; min-height: 3rem; }

    .commission-meta-row { display:flex; flex-wrap:wrap; gap:0.75rem; margin-top: 0.15rem; }
    .commission-meta-item { flex: 1 1 160px; background:#f8fafc; border:1px solid #e2e8f0; border-radius: 0.85rem; padding: 0.7rem 0.9rem; color:#0f172a; display:flex; flex-direction:column; gap: 0.2rem; min-width: 180px; }
    .commission-meta-label { font-size: 0.78rem; text-transform: uppercase; letter-spacing: 0.08em; color:#64748b; font-weight: 800; }
    .commission-meta-value { font-size: 1.02rem; color:#0f172a; font-weight: 800; }
    .commission-meta-value.muted { font-weight: 700; }

    .commission-empty { grid-column: 1 / -1; text-align:center; color:#475569; }
    .commission-empty .btn-primary { width:auto; margin-top: 0.85rem; }
    @media (max-width: 640px) {
      .commission-top { flex-direction:column; align-items:stretch; }
      .commission-top .btn-primary { width:100%; }
      .commission-grid { grid-template-columns: 1fr; }
    }
  </style>
{% endblock %}

{% block content %}
<section class="admin-wrapper commission-admin">
  <div class="admin-header">
    <p class="admin-kicker">Administración</p>
    <h1 class="admin-title">Comisiones del AMPA</h1>
    <p class="admin-subtitle">Gestiona las comisiones, sus miembros, proyectos y reuniones con el mismo lenguaje visual que noticias y calendario.</p>
  </div>

  {# flashes rendered globally in layout #}

  <div class="commission-top">
    <a class="btn-primary" href="{{ url_for('admin.commission_edit') }}">Nueva comisión</a>
  </div>

  <div class="commission-grid">
    {% for commission in commissions %}
      {% set commission_stats = stats.get(commission.id, {}) %}
      {% set next_meeting = commission_stats.get("proxima_reunion") %}
      <a class="commission-card admin-card" href="{{ url_for('admin.commission_detail', commission_id=commission.id) }}">
        <div class="commission-card-head">
          <h3 class="commission-title">{{ commission.name }}</h3>
          <div class="commission-head-right">
            <span class="muted commission-date">{{ commission.created_at.strftime('%d/%m/%Y') if commission.created_at else "Sin fecha" }}</span>
            <span class="chip {% if commission.is_active %}chip-live{% else %}chip-off{% endif %}">
              {{ "Activa" if commission.is_active else "Inactiva" }}
            </span>
          </div>
        </div>
        {% if commission.description_html %}
          <p class="commission-desc">{{ commission.description_html|striptags|truncate(170) }}</p>
        {% else %}
          <p class="commission-desc muted">Aún no hay descripción guardada.</p>
        {% endif %}

        <div class="commission-meta-row">
          <div class="commission-meta-item">
            <span class="commission-meta-label">Miembros</span>
            <span class="commission-meta-value">{{ commission_stats.get("miembros", 0) }}</span>
          </div>
          <div class="commission-meta-item">
            <span class="commission-meta-label">Proyectos activos</span>
            <span class="commission-meta-value">{{ commission_stats.get("proyectos_activos", 0) }}</span>
          </div>
          <div class="commission-meta-item">
            <span class="commission-meta-label">Próxima reunión</span>
            {% if next_meeting %}
              <span class="commission-meta-value">{{ next_meeting.start_at.strftime("%d/%m/%Y %H:%M") }}</span>
            {% else %}
              <span class="commission-meta-value muted">No hay reuniones programadas</span>
            {% endif %}
          </div>
        </div>
      </a>
    {% else %}
      <div class="commission-empty admin-card">
        <p style="margin:0;">Todavía no hay comisiones registradas.</p>
        <a class="btn-primary" href="{{ url_for('admin.commission_edit') }}">Crear la primera comisión</a>
      </div>
    {% endfor %}
  </div>
</section>
{% endblock %}
