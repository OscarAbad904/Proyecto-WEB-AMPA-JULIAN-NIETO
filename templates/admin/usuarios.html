{% extends "public/layout.html" %}

{% block title %}Usuarios · Admin{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}" />
  <style>
    .admin-wrapper { padding-top: 2.5rem; }
    .admin-card { padding: 1rem; }
    .admin-table th, .admin-table td { padding: 0.55rem 0.65rem; font-size: 0.9rem; }
    .admin-table th { font-size: 0.75rem; }
    .chip { font-size: 0.78rem; padding: 0.18rem 0.55rem; }

    .user-searchbar {
      margin-top: 0.85rem;
      display: flex;
      gap: 0.5rem;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    }

    .user-searchbar .post-search {
      max-width: 460px;
      width: min(460px, 100%);
      margin-left: 0;
    }

    .user-actions { display:flex; gap:0.4rem; flex-wrap:wrap; align-items:center; }
    .user-actions form { margin:0; }
    .admin-table select { width: 100%; max-width: 190px; border-radius: 0.65rem; border:1px solid #cbd5e1; background: #ffffff; color:#0f172a; padding: 0.4rem 0.55rem; font-size: 0.9rem; }
    .btn-mini { width: auto; min-width: unset; padding: 0.42rem 0.7rem; border-radius: 999px; font-weight: 750; font-size: 0.86rem; line-height: 1.05; }
    .btn-danger { background: rgba(239,68,68,0.12); color:#b91c1c; border:1px solid rgba(239,68,68,0.25); box-shadow: none; }
    .btn-danger:hover { opacity: 0.9; transform: translateY(-1px); }

    .user-details { display: inline-block; }
    .user-details summary {
      list-style: none;
      cursor: pointer;
      padding: 0.42rem 0.75rem;
      border-radius: 999px;
      border: 1px solid rgba(59, 130, 246, 0.25);
      background: rgba(59, 130, 246, 0.12);
      color: #1f3ba2;
      font-weight: 800;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.86rem;
    }
    .user-details summary::-webkit-details-marker { display: none; }
    .user-details[open] summary { background: rgba(59, 130, 246, 0.18); }

    .user-menu-panel { margin-top: 0.65rem; }

    .user-edit-form {
      margin-top: 0.65rem;
      padding: 0.75rem;
      border-radius: 0.85rem;
      border: 1px solid #e2e8f0;
      background: #f8fafc;
    }
    .user-edit-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.6rem; }
    .user-edit-grid label { text-align: left; display: flex; flex-direction: column; gap: 0.25rem; font-size: 0.85rem; font-weight: 700; color: #334155; }
    .user-edit-grid input { width: 100%; border-radius: 0.65rem; border: 1px solid #cbd5e1; background: #ffffff; color: #0f172a; padding: 0.45rem 0.6rem; font-size: 0.92rem; }
    .user-edit-actions { margin-top: 0.75rem; display: flex; justify-content: flex-end; gap: 0.5rem; }

    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }

    .user-modal-dialog {
      max-width: 860px;
      width: min(860px, 94vw);
      text-align: left;
    }

    .user-modal-title { margin: 0.15rem 0 0; color: var(--color-text-base); }
    .user-modal-subtitle { margin: 0.35rem 0 0; color: var(--color-text-soft); font-weight: 600; }

    .user-modal-grid { margin-top: 1rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .user-modal-card { border: 1px solid #e2e8f0; background: #f8fafc; border-radius: 1rem; padding: 0.9rem; }
    .user-modal-card h3 { margin: 0 0 0.65rem; font-size: 0.9rem; letter-spacing: 0.08em; text-transform: uppercase; color: #475569; }
    .user-modal-actions { display: flex; flex-wrap: wrap; gap: 0.4rem; }
    .user-modal-actions .btn-primary { width: auto; }

    .user-edit-form { margin-top: 0; }
    .user-edit-actions { justify-content: flex-start; }

    @media (max-width: 860px) {
      .user-modal-grid { grid-template-columns: 1fr; }
    }

    @media (max-width: 760px) {
      .user-edit-grid { grid-template-columns: 1fr; }
    }
  </style>
{% endblock %}

{% block content %}
  <section class="admin-wrapper">
    <div class="admin-header">
      <p class="admin-kicker">Usuarios · Administración</p>
      <h1 class="admin-title">Gestión de altas y socios</h1>
      <p class="admin-subtitle">Aprueba altas pendientes, gestiona roles, activa/desactiva usuarios y reenvía enlaces para establecer contraseña.</p>
      <div class="user-searchbar">
        <label class="sr-only" for="user-search">Buscar usuarios</label>
        <input id="user-search" class="post-search" type="search" placeholder="Buscar por nombre, apellidos, email o teléfono" autocomplete="off">
        <button type="button" class="btn-primary btn-mini" id="user-search-clear" style="display:none;">Limpiar</button>
        <span class="muted" id="user-search-count" style="display:none;"></span>
      </div>
    </div>

    <div class="admin-card" style="max-width: 1100px; margin: 0 auto 1.25rem;">
      <h2 style="margin: 0 0 0.5rem;">Altas pendientes</h2>
      <p class="muted" style="margin: 0 0 1rem;">Usuarios con <strong>aprobación pendiente</strong>. Se recomienda verificar el email antes de aprobar.</p>

      {% if pending_users %}
        <div class="table-responsive">
          <table class="admin-table" id="pending-users-table">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Email</th>
                <th>Teléfono</th>
                <th>Email verificado</th>
                <th>Creado</th>
                {% if can_manage_members %}<th>Modificar</th>{% endif %}
              </tr>
            </thead>
            <tbody>
              {% for u in pending_users %}
                <tr data-user-search="{{ (u.first_name or '') ~ ' ' ~ (u.last_name or '') ~ ' ' ~ (u.email or '') ~ ' ' ~ (u.phone_number or '') ~ ' ' ~ (u.role.name if u.role else '') }}">
                  <td>{{ (u.first_name or '') ~ ' ' ~ (u.last_name or '') }}</td>
                  <td>{{ u.email }}</td>
                  <td>{{ u.phone_number or '' }}</td>
                  <td>
                    {% if u.email_verified %}
                      <span class="chip chip-live">Sí</span>
                    {% else %}
                      <span class="chip chip-off">No</span>
                    {% endif %}
                  </td>
                  <td>{{ u.created_at or '' }}</td>
                  {% if can_manage_members %}
                    <td>
                      <button
                        type="button"
                        class="btn-primary btn-mini"
                        data-open-user-modal="user-modal-{{ u.id }}"
                      >Modificar</button>
                    </td>
                  {% endif %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <p class="muted" id="pending-users-empty" style="display:none; margin: 0.75rem 0 0;">No hay coincidencias para la búsqueda.</p>
      {% else %}
        <p class="muted" style="margin: 0;">No hay altas pendientes.</p>
      {% endif %}
    </div>

    <div class="admin-card" style="max-width: 1100px; margin: 0 auto;">
      <h2 style="margin: 0 0 0.5rem;">Gestión de usuarios</h2>
      <p class="muted" style="margin: 0 0 1rem;">Acciones disponibles según tus permisos.</p>

      <div class="table-responsive">
        <table class="admin-table" id="users-table">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Email</th>
              <th>Teléfono</th>
              <th>Rol</th>
              <th>Verificado</th>
              <th>Aprobado</th>
              <th>Activo</th>
              {% if can_manage_members %}<th>Modificar</th>{% endif %}
            </tr>
          </thead>
          <tbody>
            {% for u in users %}
              <tr data-user-search="{{ (u.first_name or '') ~ ' ' ~ (u.last_name or '') ~ ' ' ~ (u.email or '') ~ ' ' ~ (u.phone_number or '') ~ ' ' ~ (u.role.name if u.role else '') }}">
                <td>{{ (u.first_name or '') ~ ' ' ~ (u.last_name or '') }}</td>
                <td>{{ u.email }}</td>
                <td>{{ u.phone_number or '' }}</td>
                <td>{{ u.role.name if u.role else '' }}</td>
                <td>
                  {% if u.email_verified %}
                    <span class="chip chip-live">Sí</span>
                  {% else %}
                    <span class="chip chip-off">No</span>
                  {% endif %}
                </td>
                <td>
                  {% if u.registration_approved %}
                    <span class="chip chip-live">Sí</span>
                  {% else %}
                    <span class="chip chip-off">No</span>
                  {% endif %}
                </td>
                <td>
                  {% if u.is_active %}
                    <span class="chip chip-live">Sí</span>
                  {% else %}
                    <span class="chip chip-off">No</span>
                  {% endif %}
                </td>
                {% if can_manage_members %}
                  <td>
                    <button
                      type="button"
                      class="btn-primary btn-mini"
                      data-open-user-modal="user-modal-{{ u.id }}"
                    >Modificar</button>
                  </td>
                {% endif %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <p class="muted" id="users-table-empty" style="display:none; margin: 0.75rem 0 0;">No hay coincidencias para la búsqueda.</p>
    </div>
  </section>

  {% if can_manage_members %}
    {% for u in users %}
      <div id="user-modal-{{ u.id }}" class="login-modal" aria-hidden="true">
        <div class="login-modal-dialog user-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="user-modal-title-{{ u.id }}">
          <button class="login-modal-close" type="button" aria-label="Cerrar" data-close-user-modal>&times;</button>
          <p class="eyebrow">Usuarios</p>
          <h2 class="user-modal-title" id="user-modal-title-{{ u.id }}">Modificar</h2>
          <p class="user-modal-subtitle">{{ (u.first_name or '') ~ ' ' ~ (u.last_name or '') }} &middot; {{ u.email }}</p>

          <div class="user-modal-grid">
            <div class="user-modal-card">
              <h3>Opciones</h3>
              <div class="user-modal-actions">
                {% if not u.email_verified %}
                  <form method="post" action="{{ url_for('admin.reenviar_verificacion_usuario', user_id=u.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn-primary btn-mini">Enviar verificación</button>
                  </form>
                {% endif %}

                {% if not u.registration_approved %}
                  <form method="post" action="{{ url_for('admin.aprobar_usuario', user_id=u.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn-primary btn-mini">Aprobar alta</button>
                  </form>
                {% endif %}

                <form method="post" action="{{ url_for('admin.cambiar_estado_usuario', user_id=u.id) }}">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <input type="hidden" name="is_active" value="{{ 0 if u.is_active else 1 }}">
                  {% if u.is_active %}
                    <button type="submit" class="btn-primary btn-mini btn-danger">Desactivar</button>
                  {% else %}
                    <button type="submit" class="btn-primary btn-mini">Activar</button>
                  {% endif %}
                </form>

                {% if u.registration_approved and u.is_active %}
                  <form method="post" action="{{ url_for('admin.reenviar_set_password', user_id=u.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn-primary btn-mini">Reenviar set-password</button>
                  </form>
                {% endif %}
              </div>
            </div>

            <div class="user-modal-card">
              <h3>Rol</h3>
              {% if roles %}
                <form method="post" action="{{ url_for('admin.cambiar_rol_usuario', user_id=u.id) }}" class="user-actions" style="gap: 0.5rem;">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <select name="role_id" aria-label="Rol">
                    {% for role in roles %}
                      <option value="{{ role.id }}" {% if u.role_id == role.id %}selected{% endif %}>{{ role.name }}</option>
                    {% endfor %}
                  </select>
                  <button type="submit" class="btn-primary btn-mini">Guardar rol</button>
                </form>
              {% else %}
                <p class="muted" style="margin:0;">No hay roles disponibles.</p>
              {% endif %}
            </div>

            <div class="user-modal-card" style="grid-column: 1 / -1;">
              <h3>Correo</h3>
              <form method="post" action="{{ url_for('admin.actualizar_email_usuario', user_id=u.id) }}" class="user-edit-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="user-edit-grid" style="grid-template-columns: 1fr;">
                  <label>
                    Nuevo correo
                    <input name="email" value="{{ u.email or '' }}" maxlength="256" required>
                  </label>
                </div>
                <div class="user-edit-actions">
                  <button type="submit" class="btn-primary btn-mini">Cambiar correo</button>
                </div>
                <p class="muted" style="margin: 0.5rem 0 0;">Se enviará un enlace de verificación al nuevo correo y la cuenta quedará pendiente hasta confirmarlo.</p>
              </form>
            </div>

            <div class="user-modal-card" style="grid-column: 1 / -1;">
              <h3>Datos</h3>
              <form method="post" action="{{ url_for('admin.actualizar_datos_usuario', user_id=u.id) }}" class="user-edit-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="user-edit-grid">
                  <label>
                    Nombre
                    <input name="first_name" value="{{ u.first_name or '' }}" maxlength="64" required>
                  </label>
                  <label>
                    Apellidos
                    <input name="last_name" value="{{ u.last_name or '' }}" maxlength="64" required>
                  </label>
                  <label style="grid-column: 1 / -1;">
                    Teléfono
                    <input name="phone_number" value="{{ u.phone_number or '' }}" maxlength="32" placeholder="(opcional)">
                  </label>
                </div>
                <div class="user-edit-actions">
                  <button type="submit" class="btn-primary btn-mini">Guardar datos</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  {% endif %}
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      function toggleModal(modal, show) {
        if (!modal) return;
        modal.classList.toggle('open', show);
        modal.setAttribute('aria-hidden', show ? 'false' : 'true');
      }

      document.querySelectorAll('[data-open-user-modal]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-open-user-modal');
          const modal = id ? document.getElementById(id) : null;
          toggleModal(modal, true);
        });
      });

      document.querySelectorAll('.login-modal').forEach((modal) => {
        modal.querySelectorAll('[data-close-user-modal]').forEach((closeBtn) => {
          closeBtn.addEventListener('click', () => toggleModal(modal, false));
        });
      });

      document.addEventListener('keydown', (e) => {
        if (e.key !== 'Escape') return;
        const openModal = document.querySelector('.login-modal.open');
        if (openModal) toggleModal(openModal, false);
      });

      const searchInput = document.getElementById('user-search');
      const clearBtn = document.getElementById('user-search-clear');
      const countEl = document.getElementById('user-search-count');
      const pendingTable = document.getElementById('pending-users-table');
      const pendingEmpty = document.getElementById('pending-users-empty');
      const usersTable = document.getElementById('users-table');
      const usersEmpty = document.getElementById('users-table-empty');

      function normalizeText(value) {
        return (value || '')
          .toString()
          .toLowerCase()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .replace(/\s+/g, ' ')
          .trim();
      }

      function applyUserFilter() {
        if (!searchInput) return;
        const rawQuery = searchInput.value || '';
        const query = normalizeText(rawQuery);
        const queryDigits = rawQuery.replace(/\D/g, '');

        if (clearBtn) clearBtn.style.display = rawQuery ? '' : 'none';

        function filterTable(table, emptyEl) {
          if (!table) return { visible: 0 };
          const rows = Array.from(table.querySelectorAll('tbody tr'));
          let visible = 0;
          for (const row of rows) {
            const haystack = row.getAttribute('data-user-search') || row.textContent || '';
            const haystackNorm = normalizeText(haystack);
            const haystackDigits = haystack.replace(/\D/g, '');
            const matches =
              !query ||
              haystackNorm.includes(query) ||
              (queryDigits && haystackDigits.includes(queryDigits));
            row.style.display = matches ? '' : 'none';
            if (matches) visible += 1;
          }
          if (emptyEl) emptyEl.style.display = query && visible === 0 ? '' : 'none';
          return { visible };
        }

        const pendingRes = filterTable(pendingTable, pendingEmpty);
        const usersRes = filterTable(usersTable, usersEmpty);

        if (countEl) {
          if (!rawQuery) {
            countEl.style.display = 'none';
          } else {
            countEl.style.display = '';
            countEl.textContent = `Mostrando ${usersRes.visible} usuario(s)`;
          }
        }
      }

      if (searchInput) {
        searchInput.addEventListener('input', applyUserFilter);
      }
      if (clearBtn && searchInput) {
        clearBtn.addEventListener('click', () => {
          searchInput.value = '';
          applyUserFilter();
          searchInput.focus();
        });
      }
      applyUserFilter();
    });
  </script>
{% endblock %}
