{% extends "public/layout.html" %}
{% set hide_footer = true %}

{% block title %}Admin Eventos ¬∑ AMPA Juli√°n Nieto{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}" />
  {% include "includes/_datetime_split_picker_assets.html" %}
  <style>
    .admin-kicker-row {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 0.35rem;
      flex-wrap: wrap;
    }
    .admin-kicker-row .nav-auth-btn {
      min-width: 0;
    }

    /* Igual que /admin/posts: evita una columna de preview gigante en escritorio */
    .admin-grid {
      grid-template-columns: minmax(420px, 520px) minmax(320px, 460px);
      justify-content: center;
    }

    .event-preview-card {
      background: #f8fafc;
      border: 1px dashed #cbd5e1;
      border-radius: 1rem;
      padding: 2rem;
      min-height: 400px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: sticky;
      top: 20px;
      width: 100%;
      max-width: 460px;
    }
    .event-preview-content {
      max-width: 400px;
      background: white;
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 20px 50px rgba(0,0,0,0.15);
    }
    .event-preview-image {
      width: 100%;
      height: 200px;
      object-fit: contain;
      background: #e2e8f0;
    }
    .event-preview-body {
      padding: 1.5rem;
    }
    .event-preview-category {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #f97316;
      margin-bottom: 0.5rem;
    }
    .event-preview-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0 0 0.75rem 0;
      color: #0f172a;
    }
    .event-preview-description {
      color: #64748b;
      font-size: 0.95rem;
      line-height: 1.6;
      margin-bottom: 1rem;
    }
    .event-preview-meta {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      font-size: 0.875rem;
      color: #94a3b8;
    }
    .event-preview-meta span {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .event-preview-meta span::before {
      content: 'üìÖ';
      font-size: 1rem;
    }
    .event-preview-meta span:nth-child(2)::before {
      content: 'üìç';
    }
    .event-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .event-row {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 1rem;
      padding: 1rem;
      background: white;
      border-radius: 0.75rem;
      border: 1px solid #e2e8f0;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .event-row:hover {
      border-color: #fbbf24;
      box-shadow: 0 4px 12px rgba(251, 191, 36, 0.15);
    }
    .event-thumb {
      width: 120px;
      height: 80px;
      border-radius: 0.5rem;
      overflow: hidden;
      background: #f1f5f9;
    }
    .event-thumb img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    .event-row h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1.1rem;
      color: #0f172a;
    }
    .event-row p {
      margin: 0;
      color: #64748b;
      font-size: 0.9rem;
    }
    .delete-event-btn {
      background: rgba(239, 68, 68, 0.1);
      color: #b91c1c;
      border: 1px solid rgba(239, 68, 68, 0.25);
      padding: 0.4rem 0.8rem;
      border-radius: 0.5rem;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .delete-event-btn:hover {
      background: rgba(239, 68, 68, 0.2);
    }

    /* Modal de confirmaci√≥n (estilo web/admin) */
    .event-confirm-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 1200;
    }
    .event-confirm-modal.open { opacity: 1; pointer-events: auto; }
    .event-confirm-modal__dialog {
      background: #ffffff;
      border-radius: 1rem;
      width: min(92vw, 520px);
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.25);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid #e2e8f0;
    }
    .event-confirm-modal__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid #e2e8f0;
    }
    .event-confirm-modal__header h3 { margin: 0; color:#0f172a; }
    .event-confirm-modal__close {
      background: none;
      border: none;
      font-size: 1.5rem;
      line-height: 1;
      cursor: pointer;
      color: #64748b;
    }
    .event-confirm-modal__body {
      padding: 1rem 1.25rem 1.25rem;
      color: #0f172a;
    }
    .event-confirm-modal__body p { margin: 0.35rem 0; color:#475569; }
    .event-confirm-modal__title { color:#0f172a; font-weight: 800; }
    .event-confirm-modal__actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.6rem;
      margin-top: 1rem;
    }
    .event-confirm-cancel {
      background: #ffffff;
      color: #0f172a;
      border: 1px solid #cbd5e1;
      padding: 0.55rem 0.9rem;
      border-radius: 0.6rem;
      font-size: 0.9rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }
    .event-confirm-cancel:hover {
      background: #f8fafc;
    }

    /* Ajustes de proporciones del formulario: fecha m√°s ancha, hora/aforo m√°s estrechos */
    .field-row.field-row--location-capacity {
      grid-template-columns: 1fr 110px;
    }

    .field-row.field-row--datetime {
      grid-template-columns: 1fr 110px;
    }

    .datetime-head {
      display: grid;
      grid-template-columns: minmax(180px, 1fr) 110px;
      gap: 0.75rem;
      align-items: end;
    }

    .datetime-head label {
      display: block;
      font-weight: 600;
      color: #334155;
      margin-bottom: 0.35rem;
    }

    .datetime-head__right {
      text-align: right;
    }

    .datetime-head--end {
      grid-template-columns: 1fr;
    }

    .time-only.time-only--right {
      justify-content: end;
    }

    @media (max-width: 980px) {
      .admin-grid {
        grid-template-columns: 1fr;
        justify-content: stretch;
      }
      .event-preview-card {
        max-width: none;
        position: static;
      }

      .field-row.field-row--location-capacity {
        grid-template-columns: 1fr;
      }

      .field-row.field-row--datetime {
        grid-template-columns: 1fr;
      }

      .datetime-head {
        grid-template-columns: 1fr;
      }
    }
  </style>
{% endblock %}

{% block content %}
  <section class="admin-wrapper">
    <div class="admin-header">
      <div class="admin-kicker-row">
        <p class="admin-kicker">Eventos ¬∑ Administraci√≥n</p>
        <a class="nav-auth-btn nav-auth-btn--logout" href="{{ url_for('public.eventos') }}">Volver a eventos</a>
      </div>
      <h1 class="admin-title">Gestionar eventos</h1>
      <p class="admin-subtitle">Define fecha, categor√≠a y texto de eventos que m√°s adelante podremos sincronizar con el calendario p√∫blico.</p>
    </div>

    {# flashes rendered globally in layout #}

    <div class="admin-grid">
      <form class="admin-card admin-form" id="eventForm" method="post" novalidate enctype="multipart/form-data">
        {% if not can_edit_events %}
        <p class="muted" style="margin-top:0;">Solo lectura. Solicita permiso para editar eventos.</p>
        {% endif %}
        <fieldset {% if not can_edit_events %}disabled aria-disabled="true"{% endif %}>
        {{ form.csrf_token }}
          <input type="hidden" name="event_id" id="event-id" value="">
        <div class="field">
          {{ form.title.label }}
          {{ form.title(placeholder="Fiesta de Navidad solidaria", id="event-title") }}
        </div>
        <div class="field field-row">
          <div>
            {{ form.category.label }}
            {{ form.category(id="event-category") }}
          </div>
          <div>
            {{ form.status.label }}
            {{ form.status(id="event-status") }}
          </div>
        </div>
        <div class="field">
          {{ form.description.label }}
          {{ form.description(placeholder="Descripci√≥n breve del evento...", id="event-description") }}
        </div>
        <div class="field field-row field-row--datetime">
          <div>
            <div class="datetime-head" aria-hidden="true">
              <label for="startDate">Fecha</label>
              <label for="startTime" class="datetime-head__right">Hora inicio</label>
            </div>
            {{ form.start_at(id="startAt", type="hidden") }}
            <div class="datetime-split" style="margin-top: 0.5rem;">
              <input type="text" id="startDate" placeholder="Fecha" autocomplete="off" />
              <div class="timepicker-anchor">
                <input type="text" id="startTime" placeholder="Hora" autocomplete="off" />
                <div class="timepicker-popover" id="startTimePopover" aria-hidden="true"></div>
              </div>
            </div>
            {% if form.start_at.errors %}
              <small>{{ form.start_at.errors[0] }}</small>
            {% endif %}
          </div>
          <div>
            <div class="datetime-head datetime-head--end" aria-hidden="true">
              <label for="endTime" class="datetime-head__right">Hora fin</label>
            </div>
            {{ form.end_at(id="endAt", type="hidden") }}
            <div class="time-only time-only--right" style="margin-top: 0.5rem;">
              <div class="timepicker-anchor">
                <input type="text" id="endTime" placeholder="Hora" autocomplete="off" />
                <div class="timepicker-popover" id="endTimePopover" aria-hidden="true"></div>
              </div>
            </div>
            {% if form.end_at.errors %}
              <small>{{ form.end_at.errors[0] }}</small>
            {% endif %}
          </div>
        </div>
        <div class="field field-row field-row--location-capacity">
          <div>
            {{ form.location.label }}
            {{ form.location(placeholder="Sala multiusos, patio central...", id="event-location") }}
          </div>
          <div>
            {{ form.capacity.label }}
            {{ form.capacity(placeholder="45", id="event-capacity") }}
          </div>
        </div>
        <div class="field">
          {{ form.cover_image.label }}
          {{ form.cover_image(placeholder="https://drive.google.com/...", id="event-cover") }}
          <small class="helper">Puedes pegar un enlace de Google Drive.</small>
        </div>
        <div class="field">
          {{ form.cover_image_file.label }}
          {{ form.cover_image_file(id="event-cover-file") }}
          <small class="helper">Sube una imagen o proporciona una URL de Drive arriba. La imagen subida tendr√° prioridad.</small>
        </div>
        <div class="field">
          <label class="checkbox-inline" style="gap: 0.25rem;">
            <span>{{ form.is_public.label.text }}</span>
            {{ form.is_public(id="event-public") }}
          </label>
          {% if form.is_public.description %}
          <small style="display: block; margin-top: 0.5rem; color: #94a3b8;">
            {{ form.is_public.description }}
          </small>
          {% endif %}
        </div>
        {{ form.submit(class="btn-primary") }}
        </fieldset>
      </form>

      <aside class="admin-card event-preview-card">
        <div class="event-preview-content">
          <img id="preview-image" class="event-preview-image" src="{{ style_urls.placeholder }}" alt="Vista previa" />
          <div class="event-preview-body">
            <div id="preview-category" class="event-preview-category">ACTIVIDADES</div>
            <h3 id="preview-title" class="event-preview-title">T√≠tulo del evento</h3>
            <p id="preview-description" class="event-preview-description">La descripci√≥n del evento aparecer√° aqu√≠...</p>
            <div class="event-preview-meta">
              <span id="preview-date">Fecha pendiente</span>
              <span id="preview-location">Sin ubicaci√≥n</span>
            </div>
          </div>
        </div>
      </aside>
    </div>

    <div class="admin-card list-card">
      <div class="field-row" style="align-items:center;">
        <h2 style="margin:0;">Eventos creados</h2>
      </div>
      <div class="event-list">
        {% if events %}
          {% for event in events %}
            <article class="event-row" 
              data-id="{{ event.id }}"
              data-title="{{ event.title }}"
              data-category="{{ event.category or 'actividades' }}"
              data-description="{{ event.description_html|striptags if event.description_html else '' }}"
              data-start="{{ event.start_at.strftime('%Y-%m-%dT%H:%M') if event.start_at else '' }}"
              data-end="{{ event.end_at.strftime('%Y-%m-%dT%H:%M') if event.end_at else '' }}"
              data-location="{{ event.location or '' }}"
              data-capacity="{{ event.capacity or '' }}"
              data-cover="{{ event.cover_image or '' }}"
              data-public="{{ 'true' if event.is_public else 'false' }}"
              data-status="{{ event.status }}">
              <div class="event-thumb">
                <img src="{{ event.cover_image or style_urls.placeholder }}" alt="Portada" referrerpolicy="no-referrer" />
              </div>
              <div>
                <div style="display:flex; align-items:center; gap:0.4rem; flex-wrap:wrap; justify-content:space-between;">
                  <div style="display:flex; align-items:center; gap:0.4rem; flex-wrap:wrap;">
                    <span class="chip {% if event.status == 'published' %}chip-live{% endif %}">{{ 'Publicado' if event.status == 'published' else 'Borrador' }}</span>
                    <span class="muted">{{ event.start_at.strftime('%d/%m/%Y %H:%M') if event.start_at else 'Sin fecha' }}</span>
                    {% if event.category %}
                    <span class="muted">¬∑</span>
                    <span class="muted">{{ category_labels.get(event.category, event.category) }}</span>
                    {% endif %}
                  </div>
                  <button type="button" class="delete-event-btn" data-event-id="{{ event.id }}">Eliminar</button>
                </div>
                <h3>{{ event.title }}</h3>
                <p>{{ (event.description_html|striptags if event.description_html else '')[:100] }}{% if (event.description_html|striptags if event.description_html else '')|length > 100 %}‚Ä¶{% endif %}</p>
              </div>
            </article>
          {% endfor %}
        {% else %}
          <p class="muted">Todav√≠a no hay eventos creados.</p>
        {% endif %}
      </div>
    </div>

    <!-- Modal confirmaci√≥n eliminar -->
    <div class="event-confirm-modal" id="eventDeleteModal" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="event-confirm-modal__dialog" role="document">
        <div class="event-confirm-modal__header">
          <h3>Eliminar evento</h3>
          <button type="button" class="event-confirm-modal__close" id="eventDeleteClose" aria-label="Cerrar">&times;</button>
        </div>
        <div class="event-confirm-modal__body">
          <p>¬øSeguro que quieres eliminar este evento? Esta acci√≥n tambi√©n eliminar√° sus im√°genes asociadas.</p>
          <p class="event-confirm-modal__title" id="eventDeleteTitle"></p>
          <div class="event-confirm-modal__actions">
            <button type="button" class="event-confirm-cancel" id="eventDeleteCancel">Cancelar</button>
            <button type="button" class="delete-event-btn" id="eventDeleteConfirm">Eliminar</button>
          </div>
        </div>
      </div>
    </div>
  </section>
{% endblock %}

{% block scripts %}
  {% include "includes/_datetime_split_picker_scripts.html" %}
  <script type="application/json" id="event-category-labels-json">{{ category_labels|tojson }}</script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.querySelector('.admin-form');
      const titleInput = document.getElementById('event-title');
      const categorySelect = document.getElementById('event-category');
      const descriptionTextarea = document.getElementById('event-description');
      const startInput = document.getElementById('startAt');
      const endInput = document.getElementById('endAt');
      const locationInput = document.getElementById('event-location');
      const capacityInput = document.getElementById('event-capacity');
      const coverInput = document.getElementById('event-cover');
      const coverFileInput = document.getElementById('event-cover-file');
      const publicCheckbox = document.getElementById('event-public');
      const statusSelect = document.getElementById('event-status');
      
      const previewTitle = document.getElementById('preview-title');
      const previewCategory = document.getElementById('preview-category');
      const previewDescription = document.getElementById('preview-description');
      const previewDate = document.getElementById('preview-date');
      const previewLocation = document.getElementById('preview-location');
      const previewImage = document.getElementById('preview-image');
      
      const defaultImage = "{{ style_urls.placeholder }}";
      const categoryLabels = JSON.parse(document.getElementById('event-category-labels-json')?.textContent || '{}');

      // Mismo comportamiento que Noticias: normaliza URLs de Drive y aplica fallbacks.
      const drivePatterns = [
        /https?:\/\/drive\.google\.com\/file\/d\/([^/]+)\//,
        /https?:\/\/drive\.google\.com\/file\/d\/([^/]+)\/view/,
        /https?:\/\/drive\.google\.com\/open\?id=([^&]+)/,
        /https?:\/\/drive\.google\.com\/uc\?id=([^&]+)/,
        /https?:\/\/drive\.googleusercontent\.com\/d\/([^/]+)/,
        /https?:\/\/drive\.google\.com\/uc\?export=view&?id=([^&]+)/,
      ];

      function extractDriveId(url) {
        if (!url) return null;
        for (const pattern of drivePatterns) {
          const match = url.match(pattern);
          if (match && match[1]) return match[1];
        }
        try {
          const parsed = new URL(url);
          const id = parsed.searchParams.get('id');
          if (id) return id;
        } catch (e) {
          // ignore
        }
        return null;
      }

      function normalizeDriveUrl(url) {
        const id = extractDriveId(url);
        if (id) return { url: `https://drive.google.com/uc?export=view&id=${id}`, id };
        return { url: url || defaultImage, id: null };
      }

      function addDriveFallback(imgEl) {
        imgEl?.addEventListener('error', () => {
          const driveId = imgEl.dataset.driveId;
          const applied = imgEl.dataset.fallbackApplied;
          if (driveId && applied !== 'thumb') {
            imgEl.dataset.fallbackApplied = 'thumb';
            imgEl.src = `https://drive.google.com/thumbnail?id=${driveId}&sz=w800`;
            return;
          }
          if (driveId && applied !== 'alt') {
            imgEl.dataset.fallbackApplied = 'alt';
            imgEl.src = `https://lh3.googleusercontent.com/d/${driveId}=w800`;
            return;
          }
          imgEl.src = defaultImage;
        });
      }

      function setImageWithFallback(imgEl, rawUrl) {
        if (!imgEl) return;
        const { url, id } = normalizeDriveUrl(rawUrl);
        imgEl.dataset.driveId = id || '';
        imgEl.dataset.fallbackApplied = '';
        imgEl.src = url;
      }

      // Init: mismo selector de fecha/hora que en reuniones
      window.__eventDateTimePicker = window.initSplitDateTimePicker({
        nowStr: "{{ now_str }}",
        enforceStartAfterNow: false,
        formId: "eventForm",
        startAtId: "startAt",
        endAtId: "endAt",
        startDateId: "startDate",
        startTimeId: "startTime",
        endTimeId: "endTime",
        startTimePopoverId: "startTimePopover",
        endTimePopoverId: "endTimePopover",
        onChange: () => updatePreview(),
      });

      // Update preview in real-time
      function updatePreview() {
        previewTitle.textContent = titleInput.value || 'T√≠tulo del evento';
        previewCategory.textContent = categoryLabels[categorySelect.value] || categorySelect.value.toUpperCase() || 'ACTIVIDADES';
        previewDescription.textContent = descriptionTextarea.value || 'La descripci√≥n del evento aparecer√° aqu√≠...';
        
        if (startInput.value) {
          const start = new Date(startInput.value);
          const end = endInput.value ? new Date(endInput.value) : null;
          let dateText = start.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' });
          if (end) {
            dateText += ' - ' + end.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' });
          }
          previewDate.textContent = dateText;
        } else {
          previewDate.textContent = 'Fecha pendiente';
        }
        
        previewLocation.textContent = locationInput.value || 'Sin ubicaci√≥n';
      }

      // Update preview image
      function updatePreviewImage(url) {
        setImageWithFallback(previewImage, url);
      }

      // Listen to form changes
      titleInput?.addEventListener('input', updatePreview);
      categorySelect?.addEventListener('change', updatePreview);
      descriptionTextarea?.addEventListener('input', updatePreview);
      locationInput?.addEventListener('input', updatePreview);
      coverInput?.addEventListener('input', (e) => updatePreviewImage(e.target.value));
      
      coverFileInput?.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (evt) => {
            previewImage.src = evt.target.result;
          };
          reader.readAsDataURL(file);
        }
      });

      // Fallbacks para im√°genes existentes (miniaturas + preview)
      addDriveFallback(previewImage);
      document.querySelectorAll('.event-thumb img').forEach((imgEl) => {
        addDriveFallback(imgEl);
        const cover = imgEl.closest('[data-cover]')?.dataset.cover || imgEl.getAttribute('src') || '';
        setImageWithFallback(imgEl, cover);
      });

      // Click on event row to edit
      document.querySelectorAll('.event-row').forEach(row => {
        row.addEventListener('click', (e) => {
          if (e.target.classList.contains('delete-event-btn')) return;
          
          const data = row.dataset;
          const eventIdInput = document.getElementById('event-id');
          if (eventIdInput) eventIdInput.value = data.id || '';
          titleInput.value = data.title || '';
          categorySelect.value = data.category || '';
          descriptionTextarea.value = data.description || '';
          if (window.__eventDateTimePicker) {
            window.__eventDateTimePicker.setValues({ startAt: data.start || '', endAt: data.end || '' });
          } else {
            startInput.value = data.start || '';
            endInput.value = data.end || '';
          }
          locationInput.value = data.location || '';
          capacityInput.value = data.capacity || '';
          coverInput.value = data.cover || '';
          publicCheckbox.checked = data.public === 'true';
          statusSelect.value = data.status || '';
          
          updatePreview();
          updatePreviewImage(data.cover);
          
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
      });

      // Delete event
      const deleteModal = document.getElementById('eventDeleteModal');
      const deleteTitle = document.getElementById('eventDeleteTitle');
      const deleteConfirm = document.getElementById('eventDeleteConfirm');
      const deleteCancel = document.getElementById('eventDeleteCancel');
      const deleteClose = document.getElementById('eventDeleteClose');
      let pendingDeleteId = null;

      function openDeleteModal(eventId, title) {
        pendingDeleteId = eventId;
        if (deleteTitle) deleteTitle.textContent = title ? `‚Äú${title}‚Äù` : '';
        deleteModal?.classList.add('open');
        deleteModal?.setAttribute('aria-hidden', 'false');
      }

      function closeDeleteModal() {
        pendingDeleteId = null;
        deleteModal?.classList.remove('open');
        deleteModal?.setAttribute('aria-hidden', 'true');
      }

      deleteCancel?.addEventListener('click', closeDeleteModal);
      deleteClose?.addEventListener('click', closeDeleteModal);
      deleteModal?.addEventListener('click', (e) => {
        if (e.target === deleteModal) closeDeleteModal();
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && deleteModal?.classList.contains('open')) closeDeleteModal();
      });

      document.querySelectorAll('.delete-event-btn[data-event-id]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const eventId = btn.dataset.eventId;
          const title = btn.closest('.event-row')?.dataset?.title || '';
          openDeleteModal(eventId, title);
        });
      });

      deleteConfirm?.addEventListener('click', async () => {
        const eventId = pendingDeleteId;
        if (!eventId) return;

        const csrfToken = form?.querySelector('input[name="csrf_token"]')?.value;
        const body = new FormData();
        if (csrfToken) body.append('csrf_token', csrfToken);

        try {
          const res = await fetch(`/admin/eventos/${eventId}/delete`, {
            method: 'POST',
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {}),
            },
            body,
            credentials: 'same-origin',
          });
          const data = await res.json().catch(() => null);
          if (!res.ok || !data?.ok) {
            alert(data?.message || data?.error || 'No se pudo eliminar el evento');
            return;
          }
          closeDeleteModal();
          window.location.reload();
        } catch (err) {
          console.error(err);
          alert('No se pudo eliminar el evento');
        }
      });

      // Initial preview
      updatePreview();
      updatePreviewImage(coverInput?.value || '');

      // Si el usuario refresca la p√°gina, empezamos en modo "nuevo"
      const eventIdInput = document.getElementById('event-id');
      if (eventIdInput) eventIdInput.value = '';
    });
  </script>
{% endblock %}
