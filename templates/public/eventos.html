{% extends "public/layout.html" %}

{% block title %}Eventos · AMPA Julián Nieto{% endblock %}

{% block content %}
  <section class="events-section">
    <div class="container">
      <div class="events-header">
        <div class="fade-in">
          <p class="eyebrow">Próximos eventos</p>
          <h1 class="events-title">Actividades destacadas</h1>
          <p class="events-desc">Participa en nuestras actividades pensadas para toda la comunidad educativa.</p>
        </div>
        {% if can_manage_events %}
        <div class="nav-buttons fade-in">
          <a href="{{ url_for('admin.admin_eventos') }}" class="btn-primary" style="text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.65rem 1.25rem;">
            <span>⚙️</span>
            <span>Administrar eventos</span>
          </a>
        </div>
        {% endif %}
      </div>

      <div class="events-grid fade-in">
        {% if featured_events %}
          {% for event in featured_events %}
          <div class="event-card">
            <div
              class="event-cover js-event-cover{% if not event.cover_image %} event-cover-{{ loop.index }}{% endif %}"
              data-cover="{{ event.cover_image or '' }}"
              data-fallback="event-cover-{{ loop.index }}"
            ></div>
            <div class="event-content">
              <p class="event-category {% if loop.index == 2 %}orange{% elif loop.index == 3 %}green{% endif %}">
                {{ event.category|title if event.category else 'Evento' }}
              </p>
              <h3 class="event-title">{{ event.title }}</h3>
              <p class="event-desc">{{ event.description_html|striptags|truncate(120) }}</p>
              <div class="event-meta">
                <span>{{ event.start_at.strftime('%d %b %Y') }}</span>
                <span>{{ event.start_at.strftime('%H:%M') }}{% if event.location %} - {{ event.location }}{% endif %}</span>
              </div>
              <a class="btn-outline" href="{{ url_for('public.evento_detalle', slug=event.slug) }}">Ver detalle</a>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="alert">
            <p>No hay eventos próximos disponibles en este momento.</p>
          </div>
        {% endif %}
      </div>

      <div class="events-footer fade-in">
        <div>
          <p class="events-desc">Consulta todas las fechas y actividades programadas en el calendario.</p>
          {% if can_view_calendar %}
          <a class="btn-primary" href="{{ calendar_href }}">Ver calendario completo</a>
          {% endif %}
        </div>
        
        <!-- Mini-calendario de eventos próximos -->
        <div class="events-calendar" id="eventos-mini-calendario">
          <div class="loading-indicator" style="text-align: center; padding: 2rem;">
            Cargando próximos eventos...
          </div>
        </div>
      </div>
    </div>
  </section>

  <script src="{{ url_for('static', filename='js/eventos_mini_calendario.js') }}"></script>
  <script>
    // Mismo comportamiento que Noticias: normaliza URLs de Drive y aplica fallbacks.
    (function () {
      const drivePatterns = [
        /https?:\/\/drive\.google\.com\/file\/d\/([^/]+)\//,
        /https?:\/\/drive\.google\.com\/file\/d\/([^/]+)\/view/,
        /https?:\/\/drive\.google\.com\/open\?id=([^&]+)/,
        /https?:\/\/drive\.google\.com\/uc\?id=([^&]+)/,
        /https?:\/\/drive\.googleusercontent\.com\/d\/([^/]+)/,
        /https?:\/\/drive\.google\.com\/uc\?export=view&?id=([^&]+)/,
      ];

      function extractDriveId(url) {
        if (!url) return null;
        for (const pattern of drivePatterns) {
          const match = url.match(pattern);
          if (match && match[1]) return match[1];
        }
        try {
          const parsed = new URL(url);
          const id = parsed.searchParams.get('id');
          if (id) return id;
        } catch (e) {
          // ignore
        }
        return null;
      }

      function normalizeDriveUrl(url) {
        const id = extractDriveId(url);
        if (id) return { url: `https://drive.google.com/uc?export=view&id=${id}`, id };
        return { url: url || '', id: null };
      }

      function preload(url, onOk, onFail) {
        if (!url) return onFail();
        const img = new Image();
        img.referrerPolicy = 'no-referrer';
        img.onload = () => onOk(url);
        img.onerror = () => onFail();
        img.src = url;
      }

      function applyFallbackCover(el) {
        const fallbackClass = el.dataset.fallback;
        el.style.backgroundImage = '';
        if (fallbackClass) el.classList.add(fallbackClass);
      }

      function setEventCover(el, rawUrl) {
        if (!el) return;
        const fallbackClass = el.dataset.fallback;
        if (fallbackClass) el.classList.remove(fallbackClass);

        const { url, id } = normalizeDriveUrl(rawUrl);
        const tryPrimary = () => preload(url, (okUrl) => {
          el.style.backgroundImage = `url('${okUrl}')`;
        }, tryThumb);
        const tryThumb = () => {
          if (!id) return applyFallbackCover(el);
          const thumb = `https://drive.google.com/thumbnail?id=${id}&sz=w1200`;
          preload(thumb, (okUrl) => {
            el.style.backgroundImage = `url('${okUrl}')`;
          }, tryAlt);
        };
        const tryAlt = () => {
          if (!id) return applyFallbackCover(el);
          const alt = `https://lh3.googleusercontent.com/d/${id}=w1200`;
          preload(alt, (okUrl) => {
            el.style.backgroundImage = `url('${okUrl}')`;
          }, () => applyFallbackCover(el));
        };

        if (!rawUrl) {
          applyFallbackCover(el);
          return;
        }

        tryPrimary();
      }

      document.querySelectorAll('.js-event-cover').forEach((el) => {
        setEventCover(el, el.dataset.cover || '');
      });
    })();
  </script>
{% endblock %}
