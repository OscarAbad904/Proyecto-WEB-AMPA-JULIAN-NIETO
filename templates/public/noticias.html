{% extends "public/layout.html" %}

{% block title %}Noticias 路 AMPA Juli谩n Nieto{% endblock %}

{% block content %}
<section id="noticias" class="news-section" data-can-reorder="{{ 'true' if can_manage_posts else 'false' }}">
  <div class="container">
    <div class="news-header fade-in" style="display: flex; justify-content: space-between; align-items: flex-start; gap: 2rem; flex-wrap: wrap;">
      <div>
        <h1 class="news-title">ltimas Noticias</h1>
        <p class="news-subtitle">Lo m谩s reciente del AMPA, actividades, comunicados y reuniones.</p>
      </div>
      {% if can_manage_posts %}
      <div class="nav-buttons fade-in">
        <a href="{{ url_for('admin.posts') }}" class="btn-primary" style="text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.65rem 1.25rem;">
          <span>锔</span>
          <span>Administrar noticias</span>
        </a>
      </div>
      {% endif %}
    </div>

    {% if latest_three %}
    <div class="news-grid dynamic-news">
      {% for post in latest_three %}
      <article class="news-card fade-in news-open-modal layout-{{ post.tags or 'full' }}" data-index="{{ loop.index0 }}"
        data-id="{{ post.id }}" data-title="{{ post.title }}"
        data-date="{{ post.published_at.strftime('%d/%m/%Y') if post.published_at else 'Sin fecha' }}"
        data-category="{{ post.category or 'general' }}"
        data-cover="{{ post.cover_image or style_urls.placeholder }}"
        data-modalcover="{{ post.modal_image or post.cover_image or style_urls.placeholder }}"
        data-layout="{{ post.tags or 'full' }}" data-content='{{ post.body_html|tojson }}'>
        <div class="news-card-cover">
          <img src="{{ post.cover_image or style_urls.placeholder }}" alt="Portada"
            referrerpolicy="no-referrer" />
        </div>
        <div class="news-card-body">
          <h3 class="news-card-title news-title-with-chip"><span class="news-title-text">{{ post.title }}</span>{% if post.id in (unseen_post_ids or []) %}<span class="chip chip--new" data-new-label="post-{{ post.id }}">Nueva</span>{% endif %}</h3>
          <p class="news-card-desc">{{ (post.excerpt or '')[:200] }}{% if (post.excerpt or '')|length > 200 %}{% endif
            %}</p>
          <span class="news-card-date">{{ post.published_at.strftime('%d/%m/%Y') if post.published_at else 'Sin fecha'
            }}</span>
        </div>
      </article>
      {% endfor %}
    </div>
    {% endif %}

    <div class="news-articles" style="margin-top: 2rem;">
      <h3 class="news-title fade-in">Noticias y Novedades</h3>
      <div class="news-filter fade-in" id="news-filter">
        <button class="news-filter-btn active" data-filter="all">Todas</button>
        <button class="news-filter-btn" data-filter="actividades">Actividades</button>
        <button class="news-filter-btn" data-filter="comunicados">Comunicados</button>
        <button class="news-filter-btn" data-filter="reuniones">Reuniones</button>
        <button class="news-filter-btn" data-filter="general">General</button>
      </div>

      {% for post in posts %}
      <article class="news-article fade-in news-item" data-category="{{ post.category or 'general' }}"
        data-id="{{ post.id }}" data-title="{{ post.title }}"
        data-date="{{ post.published_at.strftime('%d/%m/%Y') if post.published_at else 'Sin fecha' }}"
        data-cover="{{ post.cover_image or style_urls.placeholder }}"
        data-modalcover="{{ post.modal_image or post.cover_image or style_urls.placeholder }}"
        data-layout="{{ post.tags or 'full' }}" data-content='{{ post.body_html|tojson }}'>
        <div class="news-article-header">
          <div>
            <h3 class="news-article-title news-title-with-chip"><span class="news-title-text">{{ post.title }}</span>{% if post.id in (unseen_post_ids or []) %}<span class="chip chip--new" data-new-label="post-{{ post.id }}">Nueva</span>{% endif %}</h3>
            <span class="news-article-category">{{ post.category or 'General' }} 路 {{
              post.published_at.strftime('%d/%m/%Y') if post.published_at else 'Sin fecha' }}</span>
          </div>
          <div class="news-article-icon"></div>
        </div>
        <p class="news-article-desc">{{ (post.excerpt or '')[:260] }}{% if (post.excerpt or '')|length > 260 %}{% endif
          %}</p>
      </article>
      {% endfor %}
    </div>
  </div>
</section>

<div class="news-modal" id="news-modal" aria-hidden="true">
  <div class="news-modal-backdrop"></div>
  <div class="news-modal-dialog">
    <button class="news-modal-close" type="button" aria-label="Cerrar" id="news-modal-close"></button>
    <figure class="news-modal-cover">
      <img id="modal-image" class="modal-zoomable" src="" alt="Imagen de portada" referrerpolicy="no-referrer" />
    </figure>
    <div class="news-modal-body">
      <p class="news-modal-meta" id="modal-meta"></p>
      <h2 id="modal-title"></h2>
      <div id="modal-content"></div>
    </div>
  </div>
</div>

<style>
  /* --- News Cards --- */
  .news-card {
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
    height: 100%;
    box-shadow: 0 12px 32px rgba(3, 7, 18, 0.45);
    transition: transform 0.25s, box-shadow 0.25s;
  }

  .news-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 20px 56px rgba(3, 7, 18, 0.75);
  }

  .news-card.layout-bottom {
    flex-direction: column-reverse;
  }

  .news-card-cover {
    width: 100%;
    aspect-ratio: 4 / 3;
    border-radius: 0.8rem;
    box-sizing: border-box;
    background: linear-gradient(145deg, rgba(150, 164, 178, 0.3), rgba(7, 17, 31, 0.95));
    background-clip: padding-box;
    margin: 0;
    border: 2px solid rgba(100, 116, 139, 0.5);
    box-shadow: 0 8px 24px rgba(3, 7, 18, 0.45);
    overflow: hidden;
    display: flex;
    flex: 1 1 auto;
    min-height: 11rem;
    position: relative;
  }

  /* Efecto tipo "Eventos": degradado suave sobre la imagen */
  .news-card-cover::after {
    content: "";
    position: absolute;
    inset: 2px;
    border-radius: 0.6rem;
    pointer-events: none;
    background: linear-gradient(180deg, transparent 30%, rgba(7, 17, 31, 0.25) 100%);
  }

  .news-card-cover img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
    position: relative;
    z-index: 0;
  }

  .news-card-body {
    flex: 1 1 auto;
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .news-title-with-chip {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .news-title-text {
    min-width: 0;
    flex: 1 1 auto;
  }

  @media (min-width: 768px) {
    .news-card.layout-left { flex-direction: row; align-items: stretch; }
    .news-card.layout-right { flex-direction: row-reverse; align-items: stretch; }

    .news-card.layout-left .news-card-cover,
    .news-card.layout-right .news-card-cover {
      flex: 0 0 45%;
      aspect-ratio: 4 / 3;
    }

    .news-card.layout-left .news-card-body,
    .news-card.layout-right .news-card-body {
      flex: 1 1 55%;
      min-width: 0;
    }
  }

  @media (min-width: 1024px) {
    .news-card-cover {
      aspect-ratio: auto;
      flex: 1 1 auto;
      min-height: 15rem;
    }
  }

  /* --- Header & Filters --- */
  .news-subheader {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .news-subheader .news-subtitle {
    margin-bottom: 1rem;
  }

  .news-edit-btn {
    padding: 0.35rem 0.85rem;
  }

  /* --- Modal Base --- */
  .news-modal {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1200;
    overflow: hidden;
  }

  .news-modal.open {
    display: flex;
  }

  body.modal-open {
    overflow: hidden;
  }

  .news-modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    touch-action: none;
  }

  .news-modal-dialog {
    position: relative;
    background: var(--color-panel);
    border-radius: 16px;
    border: 1px solid var(--color-border);
    width: 95vw;
    height: 95vh;
    box-shadow: 0 30px 60px rgba(3, 7, 18, 0.6);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    overscroll-behavior: contain;
    touch-action: pan-x pan-y pinch-zoom;
  }

  /* --- Modal Layouts (Desktop) --- */
  @media (min-width: 769px) {
    .news-modal-dialog.layout-full { flex-direction: column; }
    .news-modal-dialog.layout-left { flex-direction: row; align-items: stretch; }
    .news-modal-dialog.layout-right { flex-direction: row-reverse; align-items: stretch; }
    .news-modal-dialog.layout-bottom { flex-direction: column-reverse; }

    .news-modal-dialog.layout-left .news-modal-cover,
    .news-modal-dialog.layout-right .news-modal-cover {
      flex: 0 0 auto; /* No permitimos que el contenedor crezca por s铆 solo */
      width: auto;    /* El ancho lo determinar谩 la imagen interna */
      max-width: 55%;
      margin: 1rem;
      border-radius: 10px;
      aspect-ratio: auto;
      align-self: stretch;
    }

    .news-modal-dialog.layout-left .news-modal-body,
    .news-modal-dialog.layout-right .news-modal-body {
      flex: 1 1 0;
      min-width: auto;
    }

    .news-modal-dialog.layout-bottom .news-modal-cover {
      margin: 0 1rem 1rem;
    }
  }

  .news-modal-dialog.layout-none .news-modal-cover {
    display: none;
  }

  /* --- Modal Components --- */
  .news-modal-close {
    position: absolute;
    top: 1.25rem;
    right: 1.25rem;
    border: none;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 999px;
    font-size: 1.5rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    transition: all 0.2s ease;
  }

  .news-modal-close:hover {
    background: rgba(0, 0, 0, 0.8);
    transform: scale(1.1);
  }

  .news-modal-cover {
    margin: 0;
    width: 100%;
    overflow: hidden;
    background: transparent;
    flex: 0 0 auto;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .news-modal-dialog.layout-full .news-modal-cover {
    aspect-ratio: 16 / 9;
    max-height: 66%;
  }

  .news-modal-dialog.layout-bottom .news-modal-cover {
    aspect-ratio: 16 / 9;
    max-height: 66%;
  }

  .news-modal-cover img {
    width: auto;
    height: auto;
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    display: block;
    border-radius: 0.8rem;
    border: 2px solid rgba(100, 116, 139, 0.5);
    box-shadow: 0 8px 24px rgba(3, 7, 18, 0.45);
  }

  .news-modal-cover img.modal-zoomable {
    touch-action: none;
    user-select: none;
    -webkit-user-drag: none;
    transform-origin: center;
    will-change: transform;
  }

  /* Expansi贸n vertical completa en layouts left/right */
  @media (min-width: 769px) {
    .news-modal-dialog.layout-left .news-modal-cover,
    .news-modal-dialog.layout-right .news-modal-cover {
      max-height: 100%;
    }

    .news-modal-dialog.layout-left .news-modal-cover img,
    .news-modal-dialog.layout-right .news-modal-cover img {
      height: 100%;
      max-height: none;
      border-radius: 10px;
    }
  }

  .news-modal-body {
    padding: 2rem 3rem 3rem;
    overflow: auto;
    -webkit-overflow-scrolling: touch;
    flex: 1;
    scrollbar-color: rgba(255, 255, 255, 0.3) rgba(255, 255, 255, 0.06);
    scrollbar-width: thin;
    touch-action: pan-x pan-y pinch-zoom;
  }

  #modal-title {
    font-size: 2.5rem;
    margin: 0.5rem 0 1.5rem;
    color: var(--color-text-base);
    font-weight: 800;
    line-height: 1.2;
  }

  #modal-content {
    font-size: 1.2rem;
    line-height: 1.8;
    color: var(--color-text-soft);
  }

  #modal-content p { margin-bottom: 1.5rem; }

  #modal-content img {
    max-width: 100%;
    height: auto;
    border-radius: 12px;
    margin: 2rem 0;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  }

  .news-modal-meta {
    color: var(--color-text-soft);
    margin: 0 0 0.5rem;
    font-size: 1.1rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* --- Scrollbar --- */
  .news-modal-body::-webkit-scrollbar { width: 10px; }
  .news-modal-body::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.06); border-radius: 12px; }
  .news-modal-body::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.28);
    border-radius: 12px;
    border: 2px solid rgba(255, 255, 255, 0.06);
  }

  /* --- Mobile Overrides --- */
  @media (max-width: 768px) {
    .news-modal-dialog {
      flex-direction: column !important;
      display: block !important;
      height: 95vh;
      overflow-y: auto !important;
    }

    .news-modal-cover {
      width: 100% !important;
      margin: 0 !important;
      border-radius: 0 !important;
      flex: none !important;
      aspect-ratio: 16 / 9;
    }

    .news-modal-body {
      padding: 1.5rem 1.25rem 2rem !important;
      overflow: visible !important;
      flex: none !important;
    }

    #modal-title { font-size: 1.75rem !important; }

    #modal-content {
      font-size: calc(1.2rem * 0.8) !important; /* Escalado 0.8x para m贸vil */
    }

    .news-modal-meta {
      font-size: 0.9rem !important;
    }

    .news-modal-close {
      position: fixed !important;
      top: calc(2.5vh + 0.75rem);
      right: calc(2.5vw + 0.75rem);
      width: 36px;
      height: 36px;
      font-size: 1.2rem;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.7) !important;
    }
  }

  /* --- Reordering & Dragging --- */
  .dynamic-news.reorderable .news-card { cursor: grab; }
  .dynamic-news.reorderable .news-card:active { cursor: grabbing; }
  .news-card.dragging { opacity: 0.65; transform: scale(0.99); }
</style>

<script>
  /* eslint-disable */
  document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('news-modal');
    const modalImg = document.getElementById('modal-image');
    const modalTitle = document.getElementById('modal-title');
    const modalMeta = document.getElementById('modal-meta');
    const modalContent = document.getElementById('modal-content');
    const closeBtn = document.getElementById('news-modal-close');
    const modalDialog = document.querySelector('.news-modal-dialog');
    const modalCover = document.querySelector('.news-modal-cover');
    const newsSection = document.querySelector('[data-can-reorder]');
    const canReorder = newsSection ? newsSection.getAttribute('data-can-reorder') === 'true' : false;
    const featuredOrderEndpoint = "{{ url_for('admin.update_featured_order') }}";
    let isDraggingCard = false;
    let resetNewsZoom = () => {};
    const defaultImage = "{{ style_urls.placeholder }}";

    // Apply transition delay to news cards
    document.querySelectorAll('.news-card[data-index]').forEach((el) => {
      const index = parseInt(el.getAttribute('data-index'), 10);
      el.style.transitionDelay = (index * 0.08) + 's';
    });
    const drivePatterns = [
      /https?:\/\/drive\.google\.com\/file\/d\/([^/]+)\//,
      /https?:\/\/drive\.google\.com\/file\/d\/([^/]+)\/view/,
      /https?:\/\/drive\.google\.com\/open\?id=([^&]+)/,
      /https?:\/\/drive\.google\.com\/uc\?id=([^&]+)/,
      /https?:\/\/drive\.googleusercontent\.com\/d\/([^/]+)/,
      /https?:\/\/drive\.google\.com\/uc\?export=view&?id=([^&]+)/,
    ];

    function extractDriveId(url) {
      if (!url) return null;
      for (const pattern of drivePatterns) {
        const match = url.match(pattern);
        if (match && match[1]) return match[1];
      }
      try {
        const parsed = new URL(url);
        const id = parsed.searchParams.get('id');
        if (id) return id;
      } catch (e) {
        // ignore parse errors
      }
      return null;
    }

    function normalizeDriveUrl(url) {
      const id = extractDriveId(url);
      if (id) return { url: `https://drive.google.com/uc?export=view&id=${id}`, id };
      return { url: url || defaultImage, id: null };
    }

    function addDriveFallback(imgEl) {
      imgEl?.addEventListener('error', () => {
        const driveId = imgEl.dataset.driveId;
        const applied = imgEl.dataset.fallbackApplied;
        if (driveId && applied !== 'thumb') {
          imgEl.dataset.fallbackApplied = 'thumb';
          imgEl.src = `https://drive.google.com/thumbnail?id=${driveId}&sz=w1200`;
          return;
        }
        if (driveId && applied !== 'alt') {
          imgEl.dataset.fallbackApplied = 'alt';
          imgEl.src = `https://lh3.googleusercontent.com/d/${driveId}=w1200`;
          return;
        }
        imgEl.src = defaultImage;
      });
    }

    function setImageWithFallback(imgEl, rawUrl) {
      if (!imgEl) return;
      const { url, id } = normalizeDriveUrl(rawUrl);
      imgEl.dataset.driveId = id || '';
      imgEl.dataset.fallbackApplied = '';
      imgEl.src = url;
    }

    function setModalLayout(layout) {
      if (!modalDialog) return;
      const mode = layout || 'full';
      modalDialog.classList.remove('layout-full', 'layout-left', 'layout-right', 'layout-bottom', 'layout-none');
      modalDialog.classList.add(`layout-${mode}`);
    }

    function setupZoomableImage(imgEl, coverEl, modalEl) {
      if (!imgEl || !coverEl || !modalEl) return () => {};
      const state = {
        scale: 1,
        translateX: 0,
        translateY: 0,
        startX: 0,
        startY: 0,
        startTranslateX: 0,
        startTranslateY: 0,
        startDistance: 0,
        startScale: 1,
        startMidX: 0,
        startMidY: 0,
      };
      const minScale = 1;
      const maxScale = 3;

      const clamp = (value, min, max) => Math.min(max, Math.max(min, value));
      const getDistance = (a, b) => Math.hypot(b.clientX - a.clientX, b.clientY - a.clientY);
      const getMidpoint = (a, b) => ({
        x: (a.clientX + b.clientX) / 2,
        y: (a.clientY + b.clientY) / 2,
      });

      function applyTransform() {
        const baseWidth = imgEl.offsetWidth;
        const baseHeight = imgEl.offsetHeight;
        const containerWidth = coverEl.clientWidth;
        const containerHeight = coverEl.clientHeight;
        if (baseWidth && baseHeight && containerWidth && containerHeight) {
          const scaledWidth = baseWidth * state.scale;
          const scaledHeight = baseHeight * state.scale;
          const maxX = Math.max(0, (scaledWidth - containerWidth) / 2);
          const maxY = Math.max(0, (scaledHeight - containerHeight) / 2);
          state.translateX = clamp(state.translateX, -maxX, maxX);
          state.translateY = clamp(state.translateY, -maxY, maxY);
        }
        imgEl.style.transform = `translate3d(${state.translateX}px, ${state.translateY}px, 0) scale(${state.scale})`;
      }

      function reset() {
        state.scale = 1;
        state.translateX = 0;
        state.translateY = 0;
        applyTransform();
      }

      function onTouchStart(e) {
        if (!modalEl.classList.contains('open')) return;
        if (e.touches.length === 1) {
          const touch = e.touches[0];
          state.startX = touch.clientX;
          state.startY = touch.clientY;
          state.startTranslateX = state.translateX;
          state.startTranslateY = state.translateY;
        } else if (e.touches.length >= 2) {
          const t1 = e.touches[0];
          const t2 = e.touches[1];
          state.startDistance = getDistance(t1, t2) || 1;
          state.startScale = state.scale;
          state.startTranslateX = state.translateX;
          state.startTranslateY = state.translateY;
          const mid = getMidpoint(t1, t2);
          const rect = coverEl.getBoundingClientRect();
          state.startMidX = mid.x - (rect.left + rect.width / 2);
          state.startMidY = mid.y - (rect.top + rect.height / 2);
        }
        e.stopPropagation();
      }

      function onTouchMove(e) {
        if (!modalEl.classList.contains('open')) return;
        if (e.touches.length === 1) {
          if (state.scale <= 1) return;
          const touch = e.touches[0];
          state.translateX = state.startTranslateX + (touch.clientX - state.startX);
          state.translateY = state.startTranslateY + (touch.clientY - state.startY);
          applyTransform();
          e.preventDefault();
        } else if (e.touches.length >= 2) {
          const t1 = e.touches[0];
          const t2 = e.touches[1];
          const distance = getDistance(t1, t2) || state.startDistance || 1;
          const nextScale = clamp(state.startScale * (distance / state.startDistance), minScale, maxScale);
          const scaleRatio = nextScale / state.startScale;
          const mid = getMidpoint(t1, t2);
          const rect = coverEl.getBoundingClientRect();
          const midX = mid.x - (rect.left + rect.width / 2);
          const midY = mid.y - (rect.top + rect.height / 2);
          state.scale = nextScale;
          state.translateX = state.startTranslateX + (midX - state.startMidX) + (1 - scaleRatio) * state.startMidX;
          state.translateY = state.startTranslateY + (midY - state.startMidY) + (1 - scaleRatio) * state.startMidY;
          applyTransform();
          e.preventDefault();
        }
        e.stopPropagation();
      }

      function onTouchEnd() {
        if (state.scale <= 1.01) reset();
      }

      imgEl.addEventListener('touchstart', onTouchStart, { passive: true });
      imgEl.addEventListener('touchmove', onTouchMove, { passive: false });
      imgEl.addEventListener('touchend', onTouchEnd);
      imgEl.addEventListener('touchcancel', onTouchEnd);
      imgEl.addEventListener('load', reset);

      return reset;
    }

    function setupTwoFingerScroll(dialogEl, coverEl, getScrollContainer) {
      if (!dialogEl) return;
      const state = { startY: 0, startScrollTop: 0, container: null };
      const isInCover = (target) => coverEl && coverEl.contains(target);
      const getAvgY = (touches) => (touches[0].clientY + touches[1].clientY) / 2;

      function onTouchStart(e) {
        if (!modal?.classList.contains('open')) return;
        if (isInCover(e.target)) return;
        if (e.touches.length >= 2) {
          const container = getScrollContainer();
          if (!container) return;
          state.container = container;
          state.startY = getAvgY(e.touches);
          state.startScrollTop = container.scrollTop;
        }
      }

      function onTouchMove(e) {
        if (!modal?.classList.contains('open')) return;
        if (isInCover(e.target)) return;
        if (e.touches.length === 1) {
          e.preventDefault();
          return;
        }
        if (e.touches.length >= 2) {
          const container = state.container || getScrollContainer();
          if (!container) return;
          const currentY = getAvgY(e.touches);
          container.scrollTop = state.startScrollTop + (state.startY - currentY);
          e.preventDefault();
        }
      }

      function onTouchEnd(e) {
        if (e.touches.length < 2) {
          state.container = null;
        }
      }

      dialogEl.addEventListener('touchstart', onTouchStart, { passive: true });
      dialogEl.addEventListener('touchmove', onTouchMove, { passive: false });
      dialogEl.addEventListener('touchend', onTouchEnd);
      dialogEl.addEventListener('touchcancel', onTouchEnd);
    }

    function getNewsScrollContainer() {
      if (!modalDialog) return null;
      const body = modalDialog.querySelector('.news-modal-body');
      if (body) {
        const style = getComputedStyle(body);
        if ((style.overflowY === 'auto' || style.overflowY === 'scroll') && body.scrollHeight > body.clientHeight) {
          return body;
        }
      }
      return modalDialog;
    }

    function openModal(data) {
      const modalCover = data.modalcover || data.cover || defaultImage;
      setImageWithFallback(modalImg, modalCover);
      modalTitle.textContent = data.title || '';
      modalMeta.textContent = `${data.category || 'General'} 路 ${data.date || 'Sin fecha'}`;
      modalContent.innerHTML = data.content || '';
      setModalLayout(data.layout);
      resetNewsZoom();
      modal.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');
      document.body.classList.add('modal-open');
    }

    const seenEndpoint = {{ url_for('api.me_mark_seen') | tojson }};
    async function markSeenPost(postId) {
      const id = Number(postId);
      if (!Number.isFinite(id) || id <= 0) return;
      try {
        const res = await fetch(seenEndpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ item_type: 'post', item_id: id }),
        });
        if (!res.ok) return;
        document.querySelectorAll(`[data-new-label="post-${id}"]`).forEach((el) => el.remove());
        if (typeof window.refreshUnreadCounts === 'function') {
          window.refreshUnreadCounts();
        }
      } catch (_) {
        // Silencioso.
      }
    }

    function closeModal() {
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden', 'true');
      document.body.classList.remove('modal-open');
      resetNewsZoom();
    }

    document.querySelectorAll('.news-open-modal, .news-item').forEach((el) => {
      el.addEventListener('click', () => {
        if (isDraggingCard) return;
        const data = el.dataset;
        markSeenPost(data.id);
        openModal({
          cover: data.cover,
          modalcover: data.modalcover,
          title: data.title,
          date: data.date,
          category: data.category,
          layout: data.layout,
          content: data.content ? JSON.parse(data.content) : ''
        });
      });
    });

    addDriveFallback(modalImg);
    document.querySelectorAll('.news-card-cover img').forEach((imgEl) => {
      const cover = imgEl.closest('[data-cover]')?.dataset.cover || imgEl.getAttribute('src') || defaultImage;
      addDriveFallback(imgEl);
      setImageWithFallback(imgEl, cover);
    });

    function persistFeaturedOrder(order) {
      if (!canReorder || !featuredOrderEndpoint) return;
      fetch(featuredOrderEndpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'same-origin',
        body: JSON.stringify({ order }),
      }).catch((error) => {
        console.error('Error actualizando el orden de noticias', error);
      });
    }

    function saveFeaturedOrder(grid) {
      const order = Array.from(grid.querySelectorAll('.news-card')).map((card) => card.dataset.id);
      persistFeaturedOrder(order);
    }

    function enableReorder() {
      const grid = document.querySelector('.dynamic-news');
      if (!grid || !canReorder) return;
      grid.classList.add('reorderable');
      let dragged = null;

      grid.querySelectorAll('.news-card').forEach((card) => {
        card.setAttribute('draggable', 'true');
        card.addEventListener('dragstart', (e) => {
          dragged = card;
          isDraggingCard = true;
          card.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
        });
        card.addEventListener('dragend', () => {
          card.classList.remove('dragging');
          setTimeout(() => { isDraggingCard = false; }, 50);
          saveFeaturedOrder(grid);
        });
      });

      grid.addEventListener('dragover', (e) => {
        e.preventDefault();
        const target = e.target.closest('.news-card');
        if (!dragged || !target || dragged === target) return;
        const cards = Array.from(grid.querySelectorAll('.news-card'));
        const draggedIndex = cards.indexOf(dragged);
        const targetIndex = cards.indexOf(target);
        if (draggedIndex < targetIndex) {
          grid.insertBefore(dragged, target.nextSibling);
        } else {
          grid.insertBefore(dragged, target);
        }
      });
    }

    enableReorder();

    resetNewsZoom = setupZoomableImage(modalImg, modalCover, modal);
    setupTwoFingerScroll(modalDialog, modalCover, getNewsScrollContainer);

    closeBtn?.addEventListener('click', closeModal);
    modal?.addEventListener('click', (e) => { if (e.target === modal || e.target === modal.querySelector('.news-modal-backdrop')) closeModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

    const filterButtons = document.querySelectorAll('#news-filter .news-filter-btn');
    const items = document.querySelectorAll('.news-item');
    filterButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const filter = btn.dataset.filter;
        filterButtons.forEach(b => b.classList.toggle('active', b === btn));
        items.forEach(item => {
          const category = item.dataset.category || 'general';
          item.style.display = (filter === 'all' || category === filter) ? '' : 'none';
        });
      });
    });
  });
</script>
{% endblock %}
