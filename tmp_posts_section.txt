@login_required
def dashboard_admin():
    return render_template("admin/dashboard.html")


@admin_bp.route("/posts", methods=["GET", "POST"])
@login_required
def posts():
    if not _user_is_privileged(current_user):
        abort(403)

    form = PostForm()
    if request.method == "GET" and not form.published_at.data:
        form.published_at.data = datetime.utcnow().date()

    recent_posts = (
        Post.query.order_by(Post.published_at.desc().nullslast(), Post.created_at.desc())
        .all()
    )
    for rp in recent_posts:
        rp.cover_image = _normalize_drive_url(rp.cover_image) or rp.cover_image

    if form.validate_on_submit():
        post: Post | None = None
        if form.post_id.data:
            try:
                post = Post.query.get(int(form.post_id.data))
            except Exception:
                post = None

        content_html = form.content.data or ""
        content_text = re.sub(r"<[^>]+>", "", content_html).strip()
        if not content_text:
            flash("Añade contenido a la noticia.", "warning")
            return render_template("admin/posts.html", form=form, posts=recent_posts)

        published_at = None
        if form.published_at.data:
            published_at = datetime.combine(form.published_at.data, datetime.min.time())
        if form.status.data == "published" and not published_at:
            published_at = datetime.utcnow()

        excerpt = form.excerpt.data or content_text[:240]

        category_value = form.category.data or "general"
        normalized_cover = _normalize_drive_url(form.cover_image.data)

        if post:
            post.title = form.title.data.strip()
            if form.title.data and post.slug:
                base_slug = slugify(form.title.data)
                slug = base_slug
                counter = 2
                existing = Post.query.filter(Post.slug == slug, Post.id != post.id).first()
                while existing:
                    slug = f"{base_slug}-{counter}"
                    existing = Post.query.filter(Post.slug == slug, Post.id != post.id).first()
                    counter += 1
                post.slug = slug
            post.body_html = content_html
            post.excerpt = excerpt
            post.status = form.status.data
            post.tags = form.image_layout.data  # usamos tags para layout
            post.cover_image = normalized_cover
            post.published_at = published_at
            post.category = category_value
            db.session.commit()
            flash("Noticia actualizada", "success")
        else:
            base_slug = slugify(form.title.data)
            slug = base_slug
            existing = Post.query.filter_by(slug=slug).first()
            counter = 2
            while existing:
                slug = f"{base_slug}-{counter}"
                existing = Post.query.filter_by(slug=slug).first()
                counter += 1

            post = Post(
                title=form.title.data.strip(),
                slug=slug,
                body_html=content_html,
                excerpt=excerpt,
                status=form.status.data,
                category=category_value,
                tags=form.image_layout.data,  # layout
                cover_image=normalized_cover,
                author_id=current_user.id,
                published_at=published_at,
            )
            db.session.add(post)
            db.session.commit()
            flash("Noticia guardada en el tablón", "success")
        return redirect(url_for("admin.posts"))

    if request.method == "POST":
        flash("Revisa los datos del formulario de noticia.", "warning")

    return render_template("admin/posts.html", form=form, posts=recent_posts)
